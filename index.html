<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e6e8ee;
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow: 0 8px 28px rgba(15, 23, 42, 0.08);
      --radius:16px;
      --gap:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:linear-gradient(180deg,#ffffff 0%, #fbfcff 70%, #ffffff 100%);
    }
    .app{max-width:1100px; margin:0 auto; padding:18px 14px 28px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 14px;
      border:1px solid var(--border);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:10;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px;}
    .brand .sub{font-size:12px; color:var(--muted);}
    .nav{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:flex-end;
    }
    .tabbtn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:all .15s ease;
    }
    .tabbtn:hover{border-color:#cfd6e6;}
    .tabbtn.active{
      background:#eff6ff;
      border-color:#c7ddff;
      color:#1d4ed8;
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:var(--gap);
      margin-top:14px;
    }
    .card{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:15px;
    }
    .row{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
      align-items:end;
    }
    .field{grid-column: span 3;}
    .field.span-2{grid-column: span 2;}
    .field.span-4{grid-column: span 4;}
    .field.span-6{grid-column: span 6;}
    .field.span-12{grid-column: span 12;}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:90px; resize:vertical;}
    input:focus, select:focus, textarea:focus{border-color:#b7c7ea; box-shadow:0 0 0 3px rgba(37,99,235,0.10);}
    input[type="number"]{appearance:textfield;}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      background:var(--primary);
      color:#fff;
      transition:all .15s ease;
    }
    .btn:hover{background:var(--primary2);}
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      font-weight:600;
    }
    .btn.secondary:hover{border-color:#cfd6e6;}
    .btn.danger{background:var(--danger);}
    .btn.ok{background:var(--ok);}
    .hint{font-size:12px; color:var(--muted); margin-top:10px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff;
      font-size:12px; color:var(--muted);
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:9999;
      background:#0f172a; color:#fff;
      padding:10px 12px; border-radius:14px;
      font-size:13px; box-shadow:var(--shadow);
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .muted{color:var(--muted);}
    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .kpi .title{font-size:12px; color:var(--muted);}
    .kpi .val{font-size:18px; font-weight:800; margin-top:6px;}
    @media (max-width: 900px){
      .field{grid-column: span 6;}
      .field.span-2{grid-column: span 6;}
      .field.span-4{grid-column: span 6;}
      .field.span-6{grid-column: span 12;}
      .kpi{grid-template-columns: 1fr;}
      .topbar{position:static;}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <h1>Internal ERP</h1>
        <div class="sub">Simple • Finance-first • FIFO-ready</div>
      </div>
      <div class="nav" id="nav"></div>
    </div>

    <div class="grid">
      <!-- DASHBOARD -->
      <section class="card view" id="view-dashboard">
        <h2>Dashboard</h2>

        <div class="row">
          <div class="field span-3">
            <label>From Date</label>
            <input id="dash_from" type="date" />
          </div>
          <div class="field span-3">
            <label>To Date</label>
            <input id="dash_to" type="date" />
          </div>
          <div class="field span-6">
            <label>&nbsp;</label>
            <div class="btnbar">
              <button class="btn" id="btn_dash_refresh">Refresh</button>
              <span class="pill" id="api_status">API: Not checked</span>
            </div>
          </div>
        </div>

        <div class="kpi" style="margin-top:12px;">
          <div class="box">
            <div class="title">Total Sales (USD)</div>
            <div class="val" id="kpi_sales_usd">0.00</div>
          </div>
          <div class="box">
            <div class="title">Total Sales (KHR)</div>
            <div class="val" id="kpi_sales_khr">0</div>
          </div>
          <div class="box">
            <div class="title">Gross Profit (USD)</div>
            <div class="val" id="kpi_gp">0.00</div>
          </div>
          <div class="box">
            <div class="title">Net Profit (USD)</div>
            <div class="val" id="kpi_np">0.00</div>
          </div>
          <div class="box">
            <div class="title">Inventory Value (USD)</div>
            <div class="val" id="kpi_inv">0.00</div>
          </div>
          <div class="box">
            <div class="title">Marketing Expenses (USD)</div>
            <div class="val" id="kpi_mkt">0.00</div>
          </div>
        </div>

        <div class="hint">
          Tip: If API shows “Not checked”, click Refresh once (it will ping Apps Script).
        </div>
      </section>

      <!-- INVENTORY IN -->
      <section class="card view" id="view-inventoryin" hidden>
        <h2>Inventory IN</h2>

        <div class="row">
          <div class="field span-3">
            <label>Date received</label>
            <input id="in_date" type="date" />
          </div>

          <div class="field span-3">
            <label>FX RMB → USD (2 decimals)</label>
            <input id="in_fx" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 7.20" />
          </div>

          <div class="field span-6">
            <label class="muted">FX will be reused for multiple entries</label>
            <div class="btnbar">
              <button class="btn" id="btn_in_save">Save Inventory IN</button>
              <button class="btn secondary" id="btn_in_clear">Clear</button>
            </div>
          </div>

          <div class="field span-3">
            <label>SKU</label>
            <input id="in_sku" placeholder="SKU" />
          </div>
          <div class="field span-3">
            <label>Product name</label>
            <input id="in_product" placeholder="Name" />
          </div>
          <div class="field span-3">
            <label>Category</label>
            <input id="in_category" placeholder="Type / Category" />
          </div>
          <div class="field span-3">
            <label>Location</label>
            <select id="in_location">
              <option>Home 79</option>
              <option>Home 44</option>
              <option>The Point</option>
            </select>
          </div>

          <div class="field span-3">
            <label>Color (optional)</label>
            <input id="in_color" placeholder="Color" />
          </div>
          <div class="field span-3">
            <label>Size (optional)</label>
            <input id="in_size" placeholder="Size" />
          </div>

          <div class="field span-2">
            <label>Qty received</label>
            <input id="in_qty" type="number" step="1" inputmode="numeric" placeholder="0" />
          </div>
          <div class="field span-2">
            <label>Unit price (RMB)</label>
            <input id="in_unit_rmb" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
          </div>

          <div class="field span-2">
            <label>Unit cost (USD)</label>
            <input id="in_unit_usd" type="text" readonly />
          </div>
          <div class="field span-3">
            <label>Total cost (USD)</label>
            <input id="in_total_usd" type="text" readonly />
          </div>

          <div class="field span-12">
            <label>Note</label>
            <input id="in_note" placeholder="Optional note" />
          </div>
        </div>

        <div class="hint">
          Unit cost USD = RMB unit price ÷ FX. (FX always fixed to 2 decimals)
        </div>
      </section>

      <!-- SALES -->
      <section class="card view" id="view-sales" hidden>
        <h2>Sales Order</h2>

        <div class="row">
          <div class="field span-3">
            <label>Sale date</label>
            <input id="s_date" type="date" />
          </div>

          <div class="field span-3">
            <label>Customer name</label>
            <input id="s_customer" placeholder="Optional" />
          </div>

          <div class="field span-2">
            <label>Currency</label>
            <select id="s_currency">
              <option value="USD">USD</option>
              <option value="KHR">KHR</option>
            </select>
          </div>

          <div class="field span-2">
            <label>FX KHR → USD</label>
            <input id="s_fx_khr" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 4100" />
          </div>

          <div class="field span-2">
            <label>Status</label>
            <select id="s_status">
              <option value="ORDER">Order</option>
              <option value="PREPARATION">Preparation</option>
              <option value="DELIVERY">Delivery</option>
              <option value="COMPLETED">Completed</option>
            </select>
          </div>

          <div class="field span-3">
            <label>SKU</label>
            <input id="s_sku" placeholder="SKU" />
          </div>
          <div class="field span-3">
            <label>Product name</label>
            <input id="s_product" placeholder="Name" />
          </div>
          <div class="field span-2">
            <label>Qty</label>
            <input id="s_qty" type="number" step="1" inputmode="numeric" placeholder="0" />
          </div>
          <div class="field span-2">
            <label>Selling price (per unit)</label>
            <input id="s_price" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
          </div>
          <div class="field span-2">
            <label>Line total</label>
            <input id="s_line_total" type="text" readonly />
          </div>

          <div class="field span-12">
            <label>Note</label>
            <input id="s_note" placeholder="Optional note" />
          </div>
        </div>

        <div class="btnbar">
          <button class="btn" id="btn_s_save">Save Sales</button>
          <button class="btn secondary" id="btn_s_clear">Clear</button>
        </div>

        <div class="hint">
          Inventory OUT + FIFO COGS will be calculated by Apps Script when status is COMPLETED (backend rule).
        </div>
      </section>

      <!-- EXPENSES -->
      <section class="card view" id="view-expenses" hidden>
        <h2>Operating Expenses</h2>

        <div class="row">
          <div class="field span-3">
            <label>Date</label>
            <input id="e_date" type="date" />
          </div>
          <div class="field span-3">
            <label>Category</label>
            <input id="e_cat" placeholder="Marketing / Salary / Rent ..." />
          </div>
          <div class="field span-3">
            <label>Sub-category</label>
            <input id="e_sub" placeholder="Optional" />
          </div>
          <div class="field span-3">
            <label>Amount (USD)</label>
            <input id="e_amt" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
          </div>

          <div class="field span-12">
            <label>Note</label>
            <input id="e_note" placeholder="Optional note" />
          </div>
        </div>

        <div class="btnbar">
          <button class="btn" id="btn_e_save">Save Expense</button>
          <button class="btn secondary" id="btn_e_clear">Clear</button>
        </div>
      </section>

      <!-- REPORTS -->
      <section class="card view" id="view-reports" hidden>
        <h2>Reports</h2>
        <div class="muted" style="font-size:13px;">
          Reports are generated from Sheets (Reports_PnL, Reports_BS, Dashboard).  
          In the next step we will add “Load Report” buttons if your Code.gs exposes report endpoints.
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_URL = "https://script.google.com/macros/s/AKfycbzgC6AqVVftlcvoetDa2aTVzdSbrK7FSJt7kpJCFDeHB7o7azG0Lh_yB4a4CBw1I-ML/exec";

    const VIEWS = [
      { id:"dashboard",   label:"Dashboard" },
      { id:"inventoryin", label:"Inventory IN" },
      { id:"sales",       label:"Sales" },
      { id:"expenses",    label:"Expenses" },
      { id:"reports",     label:"Reports" },
    ];

    // ====== UI HELPERS ======
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }
    function setToday(el){
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      if(!el.value) el.value = iso;
    }
    function fmt2(n){
      const x = Number(n);
      if(!isFinite(x)) return "0.00";
      return x.toFixed(2);
    }
    function fmt0(n){
      const x = Number(n);
      if(!isFinite(x)) return "0";
      return String(Math.round(x));
    }

    // ====== FETCH (text/plain + retry + timeout) ======
    async function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function postToApi(payload){
      const body = JSON.stringify(payload);
      const maxTry = 3;
      let lastErr = null;

      for(let i=1;i<=maxTry;i++){
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 15000);

        try{
          const res = await fetch(API_URL, {
            method:"POST",
            headers:{ "Content-Type":"text/plain;charset=utf-8" },
            body,
            signal: controller.signal
          });
          clearTimeout(t);

          if(!res.ok) throw new Error("HTTP " + res.status);
          const txt = await res.text();
          let data = null;
          try{ data = JSON.parse(txt); }catch(e){ data = { ok:true, raw:txt }; }
          return data;

        }catch(err){
          clearTimeout(t);
          lastErr = err;
          // retry with backoff
          await sleep(350 * i);
        }
      }

      throw lastErr || new Error("Network error");
    }

    // ====== NAV ======
    function showView(name){
      for(const v of VIEWS){
        $("view-"+v.id).hidden = (v.id !== name);
        const btn = document.querySelector(`[data-tab="${v.id}"]`);
        if(btn) btn.classList.toggle("active", v.id===name);
      }
      localStorage.setItem("erp_tab", name);
    }

    function buildNav(){
      const nav = $("nav");
      nav.innerHTML = "";
      for(const v of VIEWS){
        const b = document.createElement("button");
        b.className = "tabbtn";
        b.textContent = v.label;
        b.dataset.tab = v.id;
        b.onclick = ()=>showView(v.id);
        nav.appendChild(b);
      }
    }

    // ====== INVENTORY CALC ======
    function recalcInventory(){
      // enforce FX 2 decimals (but don’t auto-change while empty)
      const fx = Number($("in_fx").value);
      const qty = Number($("in_qty").value);
      const rmb = Number($("in_unit_rmb").value);

      if(isFinite(fx) && fx>0 && isFinite(rmb)){
        const unitUsd = rmb / fx;
        $("in_unit_usd").value = fmt2(unitUsd);
        if(isFinite(qty)){
          $("in_total_usd").value = fmt2(unitUsd * qty);
        }else{
          $("in_total_usd").value = "0.00";
        }
      }else{
        $("in_unit_usd").value = "";
        $("in_total_usd").value = "";
      }
    }

    // ====== SALES CALC ======
    function recalcSales(){
      const qty = Number($("s_qty").value);
      const price = Number($("s_price").value);
      const cur = $("s_currency").value;
      const fx = Number($("s_fx_khr").value);

      const line = (isFinite(qty)&&isFinite(price)) ? (qty*price) : 0;
      if(cur === "USD"){
        $("s_line_total").value = fmt2(line);
      }else{
        // KHR number can be large, keep as integer-looking
        $("s_line_total").value = fmt0(line);
      }

      // if KHR selected, FX required; we keep it for backend conversion
      if(cur==="KHR"){
        $("s_fx_khr").disabled = false;
      }else{
        $("s_fx_khr").disabled = true;
        $("s_fx_khr").value = "";
      }
    }

    // ====== API ACTIONS (match Code.gs routing later) ======
    async function apiPing(){
      const s = $("api_status");
      s.textContent = "API: Checking...";
      try{
        const data = await postToApi({ action:"ping" });
        s.textContent = "API: OK";
        s.style.borderColor = "#bbf7d0";
        s.style.background = "#f0fdf4";
        s.style.color = "#166534";
        return data;
      }catch(e){
        s.textContent = "API: Failed";
        s.style.borderColor = "#fecaca";
        s.style.background = "#fef2f2";
        s.style.color = "#991b1b";
        throw e;
      }
    }

    async function saveInventoryIn(){
      // lock FX to 2 decimals at save time
      const fx = Number($("in_fx").value);
      if(!(isFinite(fx) && fx>0)){
        toast("Enter FX (RMB→USD)");
        return;
      }
      $("in_fx").value = fx.toFixed(2);

      const payload = {
        action:"inventory_in_add",
        date: $("in_date").value,
        sku: $("in_sku").value.trim(),
        product_name: $("in_product").value.trim(),
        category: $("in_category").value.trim(),
        color: $("in_color").value.trim(),
        size: $("in_size").value.trim(),
        location: $("in_location").value,
        qty: Number($("in_qty").value),
        unit_price_rmb: Number($("in_unit_rmb").value),
        fx_rmb_usd: Number($("in_fx").value),
        note: $("in_note").value.trim()
      };

      try{
        await postToApi(payload);
        toast("Saved Inventory IN");
        // keep FX for session
        $("in_sku").value = "";
        $("in_product").value = "";
        $("in_category").value = "";
        $("in_color").value = "";
        $("in_size").value = "";
        $("in_qty").value = "";
        $("in_unit_rmb").value = "";
        $("in_unit_usd").value = "";
        $("in_total_usd").value = "";
        $("in_note").value = "";
      }catch(e){
        toast("Save failed. Try again.");
      }
    }

    async function saveSales(){
      const cur = $("s_currency").value;
      if(cur==="KHR"){
        const fx = Number($("s_fx_khr").value);
        if(!(isFinite(fx) && fx>0)){
          toast("Enter FX KHR→USD");
          return;
        }
      }
      const payload = {
        action:"sales_add",
        date: $("s_date").value,
        customer_name: $("s_customer").value.trim(),
        currency: cur,
        fx_khr_to_usd: cur==="KHR" ? Number($("s_fx_khr").value) : "",
        status: $("s_status").value,
        sku: $("s_sku").value.trim(),
        product_name: $("s_product").value.trim(),
        qty: Number($("s_qty").value),
        unit_price: Number($("s_price").value),
        note: $("s_note").value.trim()
      };

      try{
        await postToApi(payload);
        toast("Saved Sales");
        $("s_sku").value = "";
        $("s_product").value = "";
        $("s_qty").value = "";
        $("s_price").value = "";
        $("s_line_total").value = "";
        $("s_note").value = "";
      }catch(e){
        toast("Save failed. Try again.");
      }
    }

    async function saveExpense(){
      const payload = {
        action:"expense_add",
        date: $("e_date").value,
        category: $("e_cat").value.trim(),
        sub_category: $("e_sub").value.trim(),
        amount_usd: Number($("e_amt").value),
        note: $("e_note").value.trim()
      };
      try{
        await postToApi(payload);
        toast("Saved Expense");
        $("e_cat").value = "";
        $("e_sub").value = "";
        $("e_amt").value = "";
        $("e_note").value = "";
      }catch(e){
        toast("Save failed. Try again.");
      }
    }

    async function dashboardRefresh(){
      try{
        await apiPing();
      }catch(e){
        // still allow user to try again later
        return;
      }

      const from = $("dash_from").value;
      const to = $("dash_to").value;

      try{
        const data = await postToApi({ action:"dashboard_get", from, to });
        // expected keys: sales_usd, sales_khr, gross_profit_usd, net_profit_usd, inventory_value_usd, marketing_expenses_usd
        $("kpi_sales_usd").textContent = fmt2(data.sales_usd ?? 0);
        $("kpi_sales_khr").textContent = fmt0(data.sales_khr ?? 0);
        $("kpi_gp").textContent = fmt2(data.gross_profit_usd ?? 0);
        $("kpi_np").textContent = fmt2(data.net_profit_usd ?? 0);
        $("kpi_inv").textContent = fmt2(data.inventory_value_usd ?? 0);
        $("kpi_mkt").textContent = fmt2(data.marketing_expenses_usd ?? 0);
        toast("Dashboard updated");
      }catch(e){
        toast("Dashboard fetch failed");
      }
    }

    // ====== INIT ======
    function init(){
      buildNav();
      const last = localStorage.getItem("erp_tab") || "dashboard";
      showView(last);

      // default dates
      setToday($("dash_from"));
      setToday($("dash_to"));
      setToday($("in_date"));
      setToday($("s_date"));
      setToday($("e_date"));

      // listeners
      $("in_fx").addEventListener("input", recalcInventory);
      $("in_qty").addEventListener("input", recalcInventory);
      $("in_unit_rmb").addEventListener("input", recalcInventory);

      $("s_qty").addEventListener("input", recalcSales);
      $("s_price").addEventListener("input", recalcSales);
      $("s_currency").addEventListener("change", recalcSales);

      $("btn_in_save").onclick = saveInventoryIn;
      $("btn_in_clear").onclick = ()=>{
        $("in_sku").value=""; $("in_product").value=""; $("in_category").value="";
        $("in_color").value=""; $("in_size").value=""; $("in_qty").value="";
        $("in_unit_rmb").value=""; $("in_unit_usd").value=""; $("in_total_usd").value="";
        $("in_note").value="";
        toast("Cleared");
      };

      $("btn_s_save").onclick = saveSales;
      $("btn_s_clear").onclick = ()=>{
        $("s_customer").value=""; $("s_sku").value=""; $("s_product").value="";
        $("s_qty").value=""; $("s_price").value=""; $("s_line_total").value="";
        $("s_note").value="";
        toast("Cleared");
      };

      $("btn_e_save").onclick = saveExpense;
      $("btn_e_clear").onclick = ()=>{
        $("e_cat").value=""; $("e_sub").value=""; $("e_amt").value=""; $("e_note").value="";
        toast("Cleared");
      };

      $("btn_dash_refresh").onclick = dashboardRefresh;

      // initial calc
      recalcSales();
      recalcInventory();
    }

    init();
  </script>
</body>
</html>
