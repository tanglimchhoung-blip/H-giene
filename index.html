<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#ffffff; --panel:#ffffff; --line:#e9eef5; --muted:#6b7280; --text:#0f172a;
      --btn:#0f172a; --btnText:#fff; --soft:#f6f8fc;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 4px 0;font-size:32px}
    .sub{margin:0 0 18px 0;color:var(--muted);font-size:14px}
    .tabs{display:flex;gap:10px;margin:14px 0 18px 0}
    .tab{border:1px solid var(--line);background:var(--panel);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .tab.active{box-shadow:0 0 0 2px #111827 inset}
    .card{border:1px solid var(--line);background:var(--panel);border-radius:var(--radius);padding:18px;margin:0 0 16px 0}
    .title{font-size:22px;font-weight:800;margin:0 0 14px 0}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 0}
    input,select,textarea{
      width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;
      font-size:15px;outline:none
    }
    input[readonly]{background:var(--soft)}
    textarea{min-height:44px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{
      padding:12px 16px;border-radius:12px;border:0;background:var(--btn);color:var(--btnText);
      font-weight:800;cursor:pointer
    }
    .btn.soft{background:#fff;color:#111827;border:1px solid var(--line);font-weight:700}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    .msg{margin-top:10px;font-size:13px;color:#111827;white-space:pre-wrap}
    .err{color:#b91c1c}
    .ok{color:#065f46}
    .hide{display:none}
    .itemsBox{border:1px solid var(--line);border-radius:14px;padding:12px;background:var(--soft)}
    .itemsHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{font-size:13px;padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted);font-weight:700}
    td select, td input{padding:8px 10px;border-radius:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--soft);border:1px solid var(--line);font-size:12px}
    @media (max-width: 980px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 520px){
      .grid{grid-template-columns:repeat(1,minmax(0,1fr))}
      .tabs{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Internal ERP</h1>
    <p class="sub">Stable | Lists are read-only (edit in Google Sheet → Lists tab)</p>

    <div class="tabs">
      <div class="tab active" data-tab="inv">Inventory IN</div>
      <div class="tab" data-tab="sales">Sales</div>
      <div class="tab" data-tab="exp">Expenses</div>
      <div class="tab" data-tab="dash">Dashboard</div>
    </div>

    <!-- Inventory IN -->
    <div id="tab-inv" class="card">
      <div class="title">Inventory IN</div>
      <div class="grid">
        <div>
          <label>Date (yyyy-mm-dd)</label>
          <input id="inv_date" type="date" />
        </div>
        <div>
          <label>Warehouse / Location</label>
          <select id="inv_location"></select>
        </div>
        <div>
          <label>Product Category</label>
          <select id="inv_cat"></select>
        </div>
        <div>
          <label>Product Name</label>
          <input id="inv_product" placeholder="Name" />
        </div>

        <div>
          <label>Color</label>
          <select id="inv_color"></select>
        </div>
        <div>
          <label>Size</label>
          <select id="inv_size"></select>
        </div>
        <div>
          <label>Qty</label>
          <input id="inv_qty" type="number" step="1" value="0" />
        </div>
        <div>
          <label>Unit Price (RMB)</label>
          <input id="inv_unit_rmb" type="number" step="0.01" value="0" />
        </div>

        <div>
          <label>FX (RMB / USD)</label>
          <input id="inv_fx" type="number" step="0.01" value="7.20" />
        </div>
        <div>
          <label>Unit Price (USD) auto</label>
          <input id="inv_unit_usd" readonly />
        </div>
        <div>
          <label>Amount (USD) auto</label>
          <input id="inv_amount_usd" readonly />
        </div>
        <div>
          <label>Note</label>
          <input id="inv_note" />
        </div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:14px">
        <div class="note">USD calc uses 2 decimals: unit_usd = unit_rmb / fx</div>
        <button class="btn" id="btn_save_inv">Save Inventory IN</button>
      </div>
      <div id="inv_msg" class="msg"></div>
    </div>

    <!-- Sales -->
    <div id="tab-sales" class="card hide">
      <div class="title">Sales</div>
      <div class="grid">
        <div>
          <label>Order Date (yyyy-mm-dd)</label>
          <input id="so_date" type="date" />
        </div>
        <div>
          <label>Warehouse / Location</label>
          <select id="so_location"></select>
        </div>
        <div>
          <label>Customer</label>
          <input id="so_customer" />
        </div>
        <div>
          <label>Delivery Company</label>
          <select id="so_delivery"></select>
        </div>

        <div>
          <label>Currency</label>
          <select id="so_currency">
            <option value="USD">USD</option>
            <option value="KHR">KHR</option>
          </select>
        </div>
        <div>
          <label>Cash Timing</label>
          <select id="so_cash">
            <option value="BEFORE">BEFORE delivery</option>
            <option value="AFTER">AFTER delivery</option>
          </select>
        </div>
        <div>
          <label>Paid Amount</label>
          <input id="so_paid" type="number" step="0.01" value="0" />
        </div>
        <div>
          <label>Note</label>
          <input id="so_note" />
        </div>

        <div>
          <label>Telephone</label>
          <input id="so_tel" />
        </div>
        <div style="grid-column: span 3;">
          <label>Customer Address</label>
          <input id="so_addr" />
        </div>
      </div>

      <div style="margin-top:14px" class="itemsBox">
        <div class="itemsHead">
          <div style="font-weight:800">Items</div>
          <button class="btn soft" id="btn_add_item">+ Add Item</button>
        </div>

        <table id="items_table">
          <thead>
            <tr>
              <th style="width:18%">Category</th>
              <th style="width:22%">Product</th>
              <th style="width:14%">Color</th>
              <th style="width:14%">Size</th>
              <th style="width:10%">Qty</th>
              <th style="width:12%">Unit Price</th>
              <th style="width:10%">Line Total</th>
              <th style="width:5%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <div class="pill">Total: <span id="so_total">0.00</span></div>
          <div style="width:220px">
            <label>Total Override (optional)</label>
            <input id="so_total_override" type="number" step="0.01" placeholder="leave blank to auto-sum" />
          </div>
          <button class="btn" id="btn_save_sale">Save Sale</button>
        </div>
        <div id="so_msg" class="msg"></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between;margin-bottom:10px">
          <div style="font-weight:900;font-size:18px">Recent Orders</div>
          <button class="btn soft" id="btn_refresh_orders">Refresh</button>
        </div>
        <div id="orders_msg" class="msg"></div>
        <div style="overflow:auto">
          <table id="orders_table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Order ID</th>
                <th>Date</th>
                <th>Total</th>
                <th>Paid</th>
                <th>Payment</th>
                <th>Status</th>
                <th style="width:180px">Update Paid</th>
                <th>Print</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Expenses -->
    <div id="tab-exp" class="card hide">
      <div class="title">Expenses</div>
      <div class="grid">
        <div>
          <label>Date (yyyy-mm-dd)</label>
          <input id="ex_date" type="date" />
        </div>
        <div>
          <label>Warehouse / Location</label>
          <select id="ex_location"></select>
        </div>
        <div>
          <label>Expense Category</label>
          <select id="ex_cat"></select>
        </div>
        <div>
          <label>Currency</label>
          <select id="ex_currency">
            <option value="USD">USD</option>
            <option value="KHR">KHR</option>
          </select>
        </div>

        <div>
          <label>Amount</label>
          <input id="ex_amount" type="number" step="0.01" value="0" />
        </div>
        <div style="grid-column: span 3;">
          <label>Note</label>
          <input id="ex_note" />
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:14px">
        <button class="btn" id="btn_save_exp">Save Expense</button>
      </div>
      <div id="ex_msg" class="msg"></div>
    </div>

    <!-- Dashboard -->
    <div id="tab-dash" class="card hide">
      <div class="title">Dashboard</div>
      <div class="grid">
        <div>
          <label>From</label>
          <input id="dash_from" type="date" />
        </div>
        <div>
          <label>To</label>
          <input id="dash_to" type="date" />
        </div>
        <div style="align-self:end">
          <button class="btn" id="btn_dash">Run</button>
        </div>
        <div></div>
      </div>

      <div class="card" style="background:var(--soft);margin-top:14px">
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <div class="pill">Inventory IN Qty: <b id="d_inv_qty">0</b></div>
          <div class="pill">Inventory IN USD: <b id="d_inv_usd">0</b></div>
          <div class="pill">Sales Total: <b id="d_sales">0</b></div>
          <div class="pill">Expenses Total: <b id="d_exp">0</b></div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="font-weight:900;margin-bottom:10px">Remaining Inventory (Option A) — by Product Category</div>
        <div style="overflow:auto">
          <table id="rem_table">
            <thead>
              <tr>
                <th>Category</th>
                <th>IN Qty</th>
                <th>Sold Qty</th>
                <th>Remaining</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="dash_msg" class="msg"></div>
      </div>
    </div>
  </div>

<script>
  // ✅ Your current API (fixed)
  const API = "https://script.google.com/macros/s/AKfycbxXONCKr7b8bTj40p2em4cJnFuqmVraqsJhL-mOfbToPPAMkOocWZb8tE08v7o_P4ze/exec";

  // JSONP helper (no CORS issues)
  function apiGet(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cb] = (resp) => {
        try { resolve(resp); }
        finally {
          delete window[cb];
          script.remove();
        }
      };

      const url = new URL(API);
      url.searchParams.set("action", action);
      url.searchParams.set("callback", cb);

      Object.entries(params).forEach(([k,v]) => {
        if (v === undefined || v === null) return;
        url.searchParams.set(k, String(v));
      });

      script.src = url.toString();
      script.onerror = () => {
        delete window[cb];
        script.remove();
        reject(new Error("Network/API error"));
      };
      document.body.appendChild(script);
    });
  }

  function setMsg(el, text, type) {
    el.className = "msg " + (type === "err" ? "err" : "ok");
    el.textContent = text;
  }

  function todayISO() {
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${d.getFullYear()}-${mm}-${dd}`;
  }

  function round2(n) {
    n = Number(n);
    if (!isFinite(n)) n = 0;
    return Math.round((n + Number.EPSILON) * 100) / 100;
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const key = t.dataset.tab;
      document.getElementById("tab-inv").classList.toggle("hide", key !== "inv");
      document.getElementById("tab-sales").classList.toggle("hide", key !== "sales");
      document.getElementById("tab-exp").classList.toggle("hide", key !== "exp");
      document.getElementById("tab-dash").classList.toggle("hide", key !== "dash");
    });
  });

  // Dropdown helpers
  function fillSelect(sel, arr) {
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "";
    sel.appendChild(opt0);
    (arr || []).forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      sel.appendChild(o);
    });
  }

  let LISTS = {};
  async function loadLists() {
    const res = await apiGet("get_lists");
    if (!res.ok) throw new Error(res.message || "get_lists failed");
    LISTS = res.data || {};

    fillSelect(document.getElementById("inv_location"), LISTS.LOCATION);
    fillSelect(document.getElementById("inv_cat"), LISTS.PROD_CAT);
    fillSelect(document.getElementById("inv_color"), LISTS.PROD_COLOR);
    fillSelect(document.getElementById("inv_size"), LISTS.PROD_SIZE);

    fillSelect(document.getElementById("so_location"), LISTS.LOCATION);
    fillSelect(document.getElementById("so_delivery"), LISTS.DELIVERY_COMPANY);

    fillSelect(document.getElementById("ex_location"), LISTS.LOCATION);
    fillSelect(document.getElementById("ex_cat"), LISTS.EXP_CAT);
  }

  // Inventory calc
  function recalcInv() {
    const qty = Number(document.getElementById("inv_qty").value || 0);
    const unitRmb = Number(document.getElementById("inv_unit_rmb").value || 0);
    const fx = Number(document.getElementById("inv_fx").value || 1);
    const unitUsd = round2(unitRmb / fx);
    const amountUsd = round2(unitUsd * qty);
    document.getElementById("inv_unit_usd").value = unitUsd.toFixed(2);
    document.getElementById("inv_amount_usd").value = amountUsd.toFixed(2);
  }
  ["inv_qty","inv_unit_rmb","inv_fx"].forEach(id => {
    document.getElementById(id).addEventListener("input", recalcInv);
  });

  // Save Inventory IN
  document.getElementById("btn_save_inv").addEventListener("click", async () => {
    const msg = document.getElementById("inv_msg");
    setMsg(msg, "Saving...", "ok");
    try {
      const payload = {
        date: document.getElementById("inv_date").value,
        location: document.getElementById("inv_location").value,
        prod_cat: document.getElementById("inv_cat").value,
        product: document.getElementById("inv_product").value,
        color: document.getElementById("inv_color").value,
        size: document.getElementById("inv_size").value,
        qty: document.getElementById("inv_qty").value,
        unit_rmb: document.getElementById("inv_unit_rmb").value,
        fx: document.getElementById("inv_fx").value,
        note: document.getElementById("inv_note").value
      };
      const res = await apiGet("save_inventory_in", { payload: JSON.stringify(payload) });
      if (!res.ok) throw new Error(res.message);
      setMsg(msg, "OK: saved row " + res.data.row, "ok");
    } catch (e) {
      setMsg(msg, "ERROR: " + e.message, "err");
    }
  });

  // Sales items UI
  const itemsBody = document.querySelector("#items_table tbody");
  function addItemRow(defaults = {}) {
    const tr = document.createElement("tr");

    const tdCat = document.createElement("td");
    const selCat = document.createElement("select");
    fillSelect(selCat, LISTS.PROD_CAT);
    selCat.value = defaults.prod_cat || "";
    tdCat.appendChild(selCat);

    const tdProd = document.createElement("td");
    const inpProd = document.createElement("input");
    inpProd.value = defaults.product || "";
    tdProd.appendChild(inpProd);

    const tdColor = document.createElement("td");
    const selColor = document.createElement("select");
    fillSelect(selColor, LISTS.PROD_COLOR);
    selColor.value = defaults.color || "";
    tdColor.appendChild(selColor);

    const tdSize = document.createElement("td");
    const selSize = document.createElement("select");
    fillSelect(selSize, LISTS.PROD_SIZE);
    selSize.value = defaults.size || "";
    tdSize.appendChild(selSize);

    const tdQty = document.createElement("td");
    const inpQty = document.createElement("input");
    inpQty.type = "number"; inpQty.step = "1"; inpQty.value = defaults.qty ?? 1;
    tdQty.appendChild(inpQty);

    const tdPrice = document.createElement("td");
    const inpPrice = document.createElement("input");
    inpPrice.type = "number"; inpPrice.step = "0.01"; inpPrice.value = defaults.unit_price ?? 0;
    tdPrice.appendChild(inpPrice);

    const tdLT = document.createElement("td");
    const inpLT = document.createElement("input");
    inpLT.readOnly = true;
    tdLT.appendChild(inpLT);

    const tdX = document.createElement("td");
    const btnX = document.createElement("button");
    btnX.className = "btn soft";
    btnX.textContent = "×";
    btnX.addEventListener("click", () => {
      tr.remove();
      recalcSalesTotal();
    });
    tdX.appendChild(btnX);

    function recalcRow() {
      const lt = round2(Number(inpQty.value||0) * Number(inpPrice.value||0));
      inpLT.value = lt.toFixed(2);
      recalcSalesTotal();
    }
    inpQty.addEventListener("input", recalcRow);
    inpPrice.addEventListener("input", recalcRow);

    tr.appendChild(tdCat);
    tr.appendChild(tdProd);
    tr.appendChild(tdColor);
    tr.appendChild(tdSize);
    tr.appendChild(tdQty);
    tr.appendChild(tdPrice);
    tr.appendChild(tdLT);
    tr.appendChild(tdX);

    itemsBody.appendChild(tr);
    recalcRow();
  }

  function recalcSalesTotal() {
    let sum = 0;
    itemsBody.querySelectorAll("tr").forEach(tr => {
      const lt = tr.querySelectorAll("input")[2].value; // third input is line_total readonly
      sum += Number(lt || 0);
    });
    document.getElementById("so_total").textContent = round2(sum).toFixed(2);
  }

  document.getElementById("btn_add_item").addEventListener("click", () => addItemRow());

  // Save Sale
  document.getElementById("btn_save_sale").addEventListener("click", async () => {
    const msg = document.getElementById("so_msg");
    setMsg(msg, "Saving...", "ok");
    try {
      const items = [];
      itemsBody.querySelectorAll("tr").forEach(tr => {
        const sels = tr.querySelectorAll("select");
        const inputs = tr.querySelectorAll("input");
        items.push({
          prod_cat: sels[0].value,
          product: inputs[0].value,
          color: sels[1].value,
          size: sels[2].value,
          qty: inputs[1].value,
          unit_price: inputs[2-1].value // unit_price is second input (index 1)?? safer below
        });
      });

      // fix unit_price mapping safely
      const fixedItems = [];
      itemsBody.querySelectorAll("tr").forEach(tr => {
        const sels = tr.querySelectorAll("select");
        const inputs = tr.querySelectorAll("input");
        fixedItems.push({
          prod_cat: sels[0].value,
          product: inputs[0].value,
          color: sels[1].value,
          size: sels[2].value,
          qty: inputs[1].value,
          unit_price: inputs[2].value
        });
      });

      const payload = {
        order_date: document.getElementById("so_date").value,
        location: document.getElementById("so_location").value,
        customer_name: document.getElementById("so_customer").value,
        telephone: document.getElementById("so_tel").value,
        customer_address: document.getElementById("so_addr").value,
        delivery_company: document.getElementById("so_delivery").value,
        currency: document.getElementById("so_currency").value,
        cash_timing: document.getElementById("so_cash").value,
        paid_amount: document.getElementById("so_paid").value,
        note: document.getElementById("so_note").value,
        total_override: document.getElementById("so_total_override").value,
        items: fixedItems
      };

      const res = await apiGet("save_sale", { payload: JSON.stringify(payload) });
      if (!res.ok) throw new Error(res.message);

      setMsg(msg, `OK: saved ${res.data.order_id} | payment ${res.data.payment_status}`, "ok");
      await refreshOrders();
    } catch (e) {
      setMsg(msg, "ERROR: " + e.message, "err");
    }
  });

  // Recent Orders
  async function refreshOrders() {
    const msg = document.getElementById("orders_msg");
    setMsg(msg, "Loading...", "ok");
    const tbody = document.querySelector("#orders_table tbody");
    tbody.innerHTML = "";
    try {
      const res = await apiGet("get_recent_orders", { limit: 20 });
      if (!res.ok) throw new Error(res.message);
      const list = res.data || [];

      list.forEach(o => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${escapeHtml(o.customer_name || "")}</td>
          <td>${escapeHtml(o.order_id || "")}</td>
          <td>${escapeHtml(o.order_date || "")}</td>
          <td>${Number(o.total||0).toFixed(2)}</td>
          <td>${Number(o.paid_amount||0).toFixed(2)}</td>
          <td>${escapeHtml(o.payment_status || "")}</td>
          <td></td>
          <td></td>
          <td></td>
        `;

        // status dropdown
        const tdStatus = tr.children[6];
        const sel = document.createElement("select");
        ["NEW","PREPARED","DELIVERING","COMPLETED","CANCELLED"].forEach(s => {
          const op = document.createElement("option");
          op.value = s; op.textContent = s;
          sel.appendChild(op);
        });
        sel.value = o.status || "NEW";
        tdStatus.appendChild(sel);

        // update paid
        const tdUpd = tr.children[7];
        const wrap = document.createElement("div");
        wrap.className = "row";
        wrap.style.gap = "8px";
        wrap.style.flexWrap = "nowrap";

        const inpPaid = document.createElement("input");
        inpPaid.type = "number";
        inpPaid.step = "0.01";
        inpPaid.value = Number(o.paid_amount||0).toFixed(2);
        inpPaid.style.width = "110px";

        const btnUpd = document.createElement("button");
        btnUpd.className = "btn soft";
        btnUpd.textContent = "Update";
        btnUpd.addEventListener("click", async () => {
          try {
            const payload = { order_id: o.order_id, paid_amount: inpPaid.value, status: sel.value };
            const r = await apiGet("update_order", { payload: JSON.stringify(payload) });
            if (!r.ok) throw new Error(r.message);
            await refreshOrders();
          } catch (e) {
            alert("Update failed: " + e.message);
          }
        });

        wrap.appendChild(inpPaid);
        wrap.appendChild(btnUpd);
        tdUpd.appendChild(wrap);

        // print
        const tdPrint = tr.children[8];
        const btnP = document.createElement("button");
        btnP.className = "btn soft";
        btnP.textContent = "Print";
        btnP.addEventListener("click", () => printSlip(o));
        tdPrint.appendChild(btnP);

        tbody.appendChild(tr);
      });

      setMsg(msg, "OK", "ok");
    } catch (e) {
      setMsg(msg, "ERROR: " + e.message, "err");
    }
  }

  document.getElementById("btn_refresh_orders").addEventListener("click", refreshOrders);

  function printSlip(o) {
    const w = window.open("", "_blank");
    const html = `
      <html><head><title>Packing Slip</title>
      <style>
        body{font-family:Arial;padding:18px}
        .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px}
        h2{margin:0 0 10px 0}
        table{width:100%;border-collapse:collapse}
        td,th{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px}
        th{color:#666}
      </style></head>
      <body>
        <h2>Packing Slip / Delivery Label</h2>
        <div class="box">
          <div><b>Customer:</b> ${escapeHtml(o.customer_name||"")}</div>
          <div><b>Order ID:</b> ${escapeHtml(o.order_id||"")}</div>
          <div><b>Date:</b> ${escapeHtml(o.order_date||"")}</div>
          <div><b>Location:</b> ${escapeHtml(o.location||"")}</div>
          <div><b>Delivery Company:</b> ${escapeHtml(o.delivery_company||"")}</div>
          <div><b>Status:</b> ${escapeHtml(o.status||"")}</div>
          <div><b>Total:</b> ${escapeHtml(o.currency||"")} ${Number(o.total||0).toFixed(2)}</div>
        </div>
        <div class="box">
          <div><b>Note:</b> ${escapeHtml(o.note||"")}</div>
        </div>
        <script>window.print();</script>
      </body></html>
    `;
    w.document.write(html);
    w.document.close();
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // Save Expense
  document.getElementById("btn_save_exp").addEventListener("click", async () => {
    const msg = document.getElementById("ex_msg");
    setMsg(msg, "Saving...", "ok");
    try {
      const payload = {
        date: document.getElementById("ex_date").value,
        location: document.getElementById("ex_location").value,
        expense_cat: document.getElementById("ex_cat").value,
        currency: document.getElementById("ex_currency").value,
        amount: document.getElementById("ex_amount").value,
        note: document.getElementById("ex_note").value
      };
      const res = await apiGet("save_expense", { payload: JSON.stringify(payload) });
      if (!res.ok) throw new Error(res.message);
      setMsg(msg, "OK: saved row " + res.data.row, "ok");
    } catch (e) {
      setMsg(msg, "ERROR: " + e.message, "err");
    }
  });

  // Dashboard
  document.getElementById("btn_dash").addEventListener("click", async () => {
    const msg = document.getElementById("dash_msg");
    setMsg(msg, "Loading...", "ok");
    try {
      const from = document.getElementById("dash_from").value;
      const to = document.getElementById("dash_to").value;
      const res = await apiGet("dashboard", { from, to });
      if (!res.ok) throw new Error(res.message);

      const d = res.data;
      document.getElementById("d_inv_qty").textContent = (d.inventory_in_qty || 0).toFixed(2);
      document.getElementById("d_inv_usd").textContent = (d.inventory_in_amount_usd || 0).toFixed(2);
      document.getElementById("d_sales").textContent = (d.sales_total || 0).toFixed(2);
      document.getElementById("d_exp").textContent = (d.expenses_total || 0).toFixed(2);

      const tb = document.querySelector("#rem_table tbody");
      tb.innerHTML = "";
      (d.remaining_by_category || []).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.prod_cat)}</td>
          <td>${Number(r.in_qty||0).toFixed(2)}</td>
          <td>${Number(r.sold_qty||0).toFixed(2)}</td>
          <td><b>${Number(r.remaining_qty||0).toFixed(2)}</b></td>
        `;
        tb.appendChild(tr);
      });

      setMsg(msg, "OK", "ok");
    } catch (e) {
      setMsg(msg, "ERROR: " + e.message, "err");
    }
  });

  // INIT
  (async function init(){
    // set default dates
    document.getElementById("inv_date").value = todayISO();
    document.getElementById("so_date").value = todayISO();
    document.getElementById("ex_date").value = todayISO();
    document.getElementById("dash_from").value = todayISO();
    document.getElementById("dash_to").value = todayISO();

    try {
      await loadLists();
      // start with 1 item row for sales
      addItemRow();
      recalcInv();
      await refreshOrders();
    } catch (e) {
      // show error on inv tab to make it obvious
      setMsg(document.getElementById("inv_msg"), "ERROR loading lists: " + e.message, "err");
    }
  })();
</script>
</body>
</html>
