<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --pri:#2563eb; --pri2:#1d4ed8; --ok:#16a34a; --err:#dc2626;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --r:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{
      border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:999px;
      cursor:pointer; font-weight:700; color:#111827;
    }
    .tabbtn.active{background:var(--pri);color:#fff;border-color:var(--pri)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin-top:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .field{grid-column:span 3}
    .span4{grid-column:span 4}
    .span6{grid-column:span 6}
    .span12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff;
      font-size:14px; outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#7aa2ff; box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    textarea{min-height:72px;resize:vertical}
    .btn{
      border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;
      background:var(--pri);color:#fff;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:#eef2ff;color:#1e3a8a}
    .btn.gray{background:#f3f4f6;color:#111827;border:1px solid var(--line)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f8fafc;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}
    .errorBox{margin-top:10px;padding:10px;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:12px;display:none}
    .muted{color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px}
    .table th{color:var(--muted);font-weight:800;font-size:12px}
    .miniAdd{display:flex;gap:8px}
    .miniAdd .btn{padding:10px 10px}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .sectionTitle h2{margin:0;font-size:16px}
    canvas{width:100%;max-height:240px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .hide{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Internal ERP</h1>
      <div class="sub">Simple • Inventory + Sales + Expenses + Cash • + Add buttons write to Lists automatically</div>
    </div>
    <div class="tabs" id="tabs"></div>
  </header>

  <div class="card">
    <div class="grid">
      <div class="span6">
        <label>Apps Script Web App URL (paste the redirected googleusercontent echo URL if CORS blocks)</label>
        <input id="apiUrl" placeholder="https://script.googleusercontent.com/macros/echo?user_content_key=..." />
        <div class="muted" style="margin-top:6px;">
          Tip: open <b>?action=ping</b> in browser → it redirects to script.googleusercontent.com → copy that URL here.
        </div>
      </div>
      <div class="span3">
        <label>Connection</label>
        <div class="pill" id="connPill"><span class="dot err" id="connDot"></span><span id="connText">Not checked</span></div>
      </div>
      <div class="span3">
        <label>Quick actions</label>
        <div class="row">
          <button class="btn secondary" id="btnPing">Check API</button>
          <button class="btn gray" id="btnLists">Reload Lists</button>
        </div>
      </div>
    </div>
    <div class="errorBox" id="errBox"></div>
  </div>

  <!-- Dashboard -->
  <div class="card hide" id="panel-dashboard">
    <div class="sectionTitle">
      <h2>Dashboard</h2>
      <div class="row">
        <div>
          <label>From</label><input type="date" id="dashFrom">
        </div>
        <div>
          <label>To</label><input type="date" id="dashTo">
        </div>
        <button class="btn" id="btnDash">Refresh</button>
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="span4"><div class="pill"><b>Total Cash IN</b>&nbsp; <span id="mCashIn">0</span></div></div>
      <div class="span4"><div class="pill"><b>Total Cash OUT</b>&nbsp; <span id="mCashOut">0</span></div></div>
      <div class="span4"><div class="pill"><b>Total Expenses</b>&nbsp; <span id="mExp">0</span></div></div>
      <div class="span12">
        <label>Illustration</label>
        <canvas id="dashChart" height="220"></canvas>
        <div class="muted">This chart is lightweight (no library) so it stays fast.</div>
      </div>
    </div>
  </div>

  <!-- Inventory IN -->
  <div class="card" id="panel-inv">
    <div class="sectionTitle">
      <h2>Inventory IN</h2>
      <div class="muted">Unit USD = RMB / FX (2 decimals). Total USD = Unit USD × Qty.</div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="field">
        <label>Date</label>
        <input type="date" id="inDate">
      </div>
      <div class="field">
        <label>FX RMB → USD (2 decimals)</label>
        <input id="inFx" inputmode="decimal" placeholder="7.00">
      </div>
      <div class="field">
        <label>SKU</label>
        <input id="inSku" placeholder="MM-001">
      </div>
      <div class="field">
        <label>Warehouse</label>
        <div class="miniAdd">
          <select id="inWh"></select>
          <button class="btn secondary" id="addWh">+ Add</button>
        </div>
      </div>

      <div class="field">
        <label>Product category</label>
        <div class="miniAdd">
          <select id="inCat"></select>
          <button class="btn secondary" id="addCat">+ Add</button>
        </div>
      </div>
      <div class="field">
        <label>Size</label>
        <div class="miniAdd">
          <select id="inSize"></select>
          <button class="btn secondary" id="addSize">+ Add</button>
        </div>
      </div>
      <div class="field">
        <label>Color</label>
        <div class="miniAdd">
          <select id="inColor"></select>
          <button class="btn secondary" id="addColor">+ Add</button>
        </div>
      </div>
      <div class="field">
        <label>Qty</label>
        <input id="inQty" inputmode="decimal" placeholder="0">
      </div>

      <div class="field">
        <label>Unit RMB</label>
        <input id="inUnitRmb" inputmode="decimal" placeholder="0.00">
      </div>
      <div class="field">
        <label>Unit USD (auto)</label>
        <input id="inUnitUsd" readonly>
      </div>
      <div class="field">
        <label>Total USD (auto)</label>
        <input id="inTotalUsd" readonly>
      </div>
      <div class="field">
        <label>Note</label>
        <input id="inNote" placeholder="">
      </div>

      <div class="span12 row" style="margin-top:8px">
        <button class="btn" id="btnSaveInv">Save Inventory IN</button>
        <button class="btn gray" id="btnClearInv">Clear</button>
        <span class="pill" id="invStatus"><span class="dot err"></span><span>Not ready</span></span>
      </div>
    </div>
  </div>

  <!-- Sales -->
  <div class="card hide" id="panel-sales">
    <div class="sectionTitle">
      <h2>Sales (Order + multiple items)</h2>
      <div class="muted">Cash can be recorded anytime (before/after shipping). Delivery company dropdown + Add.</div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="field"><label>Date</label><input type="date" id="soDate"></div>
      <div class="field"><label>Customer name</label><input id="soCust"></div>
      <div class="field"><label>Telephone</label><input id="soTel"></div>
      <div class="field"><label>Customer address</label><input id="soAddr"></div>

      <div class="field">
        <label>Delivery company</label>
        <div class="miniAdd">
          <select id="soDelivery"></select>
          <button class="btn secondary" id="addDelivery">+ Add</button>
        </div>
      </div>
      <div class="field">
        <label>Currency for item prices</label>
        <select id="soCur">
          <option>USD</option>
          <option>KHR</option>
        </select>
      </div>
      <div class="field"><label>Status</label>
        <select id="soStatus">
          <option>Ordered</option>
          <option>Preparation</option>
          <option>Delivered</option>
          <option>Completed</option>
        </select>
      </div>
      <div class="field"><label>Paid status</label>
        <select id="soPaid">
          <option>Not received</option>
          <option>Received</option>
        </select>
      </div>

      <div class="span12"><label>Note</label><input id="soNote"></div>

      <div class="span12">
        <div class="sectionTitle" style="margin-top:6px">
          <h2 style="font-size:14px;margin:0">Items</h2>
          <button class="btn secondary" id="addItemRow">+ Add item row</button>
        </div>
        <table class="table" id="itemsTable">
          <thead>
            <tr>
              <th>SKU</th><th>Product</th><th>Qty</th><th>Unit price</th><th Reminder: line total auto</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="span12 row" style="margin-top:8px">
        <button class="btn" id="btnCreateOrder">Save Order + Items</button>
        <button class="btn gray" id="btnClearSales">Clear</button>
        <span class="pill"><b>Order total:</b>&nbsp;<span id="soTotal">0</span></span>
      </div>

      <div class="span12" style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
        <div class="sectionTitle">
          <h2 style="font-size:14px;margin:0">Record Cash Received / Refund</h2>
          <div class="muted">This is the balance sheet movement. Use IN for payment, OUT for refunds.</div>
        </div>
        <div class="grid" style="margin-top:8px">
          <div class="field"><label>Date</label><input type="date" id="cashDate"></div>
          <div class="field"><label>Direction</label>
            <select id="cashDir"><option value="IN">IN</option><option value="OUT">OUT</option></select>
          </div>
          <div class="field"><label>Amount</label><input id="cashAmt" inputmode="decimal"></div>
          <div class="field"><label>Currency</label>
            <select id="cashCur"><option>USD</option><option>KHR</option></select>
          </div>
          <div class="field"><label>FX KHR → USD (if KHR)</label><input id="cashFx" inputmode="decimal" placeholder="0"></div>
          <div class="span6"><label>Note</label><input id="cashNote"></div>
          <div class="span12 row">
            <button class="btn secondary" id="btnCash">Record Cash</button>
            <span class="muted" id="cashHint">Tip: Save Order first, then record cash referencing that order_id shown after save.</span>
          </div>
          <div class="span12"><div class="pill" id="lastOrderPill">Last order_id: <b id="lastOrderId">-</b></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Expenses -->
  <div class="card hide" id="panel-exp">
    <div class="sectionTitle">
      <h2>Expenses</h2>
      <div class="muted">Expense categories come from Lists (EXP_CAT) + you can + Add.</div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="field"><label>Date</label><input type="date" id="exDate"></div>
      <div class="field">
        <label>Category</label>
        <div class="miniAdd">
          <select id="exCat"></select>
          <button class="btn secondary" id="addExpCat">+ Add</button>
        </div>
      </div>
      <div class="field"><label>Amount</label><input id="exAmt" inputmode="decimal"></div>
      <div class="field"><label>Currency</label>
        <select id="exCur"><option>USD</option><option>KHR</option></select>
      </div>
      <div class="field"><label>FX KHR → USD (if KHR)</label><input id="exFx" inputmode="decimal" placeholder="0"></div>
      <div class="span6"><label>Note</label><input id="exNote"></div>

      <div class="span12 row">
        <button class="btn" id="btnExp">Save Expense</button>
        <button class="btn gray" id="btnClearExp">Clear</button>
      </div>
    </div>
  </div>

  <!-- Reports -->
  <div class="card hide" id="panel-rep">
    <div class="sectionTitle">
      <h2>Reports (date range)</h2>
      <div class="muted">This UI is ready. If you want full computed PnL/BS, we can add formulas in Sheets later.</div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>From</label><input type="date" id="repFrom"></div>
      <div><label>To</label><input type="date" id="repTo"></div>
      <button class="btn" id="btnRep">Refresh</button>
    </div>
    <div class="muted" style="margin-top:10px">Next step can load rows from sheets and summarize. (UI already has date range selectors.)</div>
  </div>
</div>

<script>
  // ===== Tabs =====
  const TAB_DEFS = [
    {id:"dashboard", label:"Dashboard", panel:"panel-dashboard"},
    {id:"inv",       label:"Inventory IN", panel:"panel-inv"},
    {id:"sales",     label:"Sales", panel:"panel-sales"},
    {id:"exp",       label:"Expenses", panel:"panel-exp"},
    {id:"rep",       label:"Reports", panel:"panel-rep"},
  ];

  const tabsEl = document.getElementById("tabs");
  let activeTab = "inv";

  function setTab(id){
    activeTab = id;
    TAB_DEFS.forEach(t=>{
      const btn = document.getElementById("tab-"+t.id);
      const panel = document.getElementById(t.panel);
      if (btn) btn.classList.toggle("active", t.id===id);
      if (panel) panel.classList.toggle("hide", t.id!==id);
    });
  }

  function buildTabs(){
    tabsEl.innerHTML = "";
    TAB_DEFS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tabbtn";
      b.id = "tab-"+t.id;
      b.textContent = t.label;
      b.onclick = ()=>setTab(t.id);
      tabsEl.appendChild(b);
    });
    setTab(activeTab);
  }

  // ===== API =====
  const apiUrlEl = document.getElementById("apiUrl");
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const errBox = document.getElementById("errBox");

  function showErr(msg){
    errBox.style.display = msg ? "block" : "none";
    errBox.textContent = msg || "";
  }

  function setConn(ok, text){
    connDot.className = "dot " + (ok ? "ok":"err");
    connText.textContent = text;
  }

  function getApiUrl(){
    return (apiUrlEl.value || "").trim();
  }

  function saveApiUrl(){
    localStorage.setItem("ERP_API_URL", getApiUrl());
  }

  async function apiGet(action){
    const base = getApiUrl();
    if (!base) throw new Error("API URL is empty");
    const url = base + (base.includes("?") ? "&" : "?") + "action=" + encodeURIComponent(action);
    const res = await fetch(url, {method:"GET"});
    return await res.json();
  }

  async function apiPost(payload){
    const base = getApiUrl();
    if (!base) throw new Error("API URL is empty");
    const res = await fetch(base, {
      method:"POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  // ===== Lists =====
  const lists = {
    locations:[], expCats:[], prodCats:[], prodSizes:[], prodColors:[], deliveryCos:[]
  };

  function fillSelect(sel, arr, placeholder){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder || "Select...";
    sel.appendChild(opt0);

    (arr || []).forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
  }

  async function reloadLists(){
    showErr("");
    setConn(false, "Loading lists...");
    const r = await apiGet("lists");
    if (!r.ok) throw new Error(r.error || "Failed to load lists");
    Object.assign(lists, r.data || {});
    // Inventory dropdowns
    fillSelect(document.getElementById("inWh"),   lists.locations,  "Select warehouse...");
    fillSelect(document.getElementById("inCat"),  lists.prodCats,   "Select category...");
    fillSelect(document.getElementById("inSize"), lists.prodSizes,  "Select size...");
    fillSelect(document.getElementById("inColor"),lists.prodColors, "Select color...");
    // Sales delivery
    fillSelect(document.getElementById("soDelivery"), lists.deliveryCos, "Select delivery...");
    // Expenses
    fillSelect(document.getElementById("exCat"), lists.expCats, "Select category...");
    setConn(true, "Lists loaded");
  }

  async function quickAdd(listName){
    const value = prompt("Add new value to " + listName + " (this writes into Lists sheet)");
    if (!value) return;
    const r = await apiPost({action:"add_list_item", list_name:listName, value:value});
    if (!r.ok) throw new Error(r.error || "Add failed");
    await reloadLists();
    alert("Added: " + value);
  }

  // ===== Inventory calc + save =====
  const inFx = document.getElementById("inFx");
  const inQty = document.getElementById("inQty");
  const inUnitRmb = document.getElementById("inUnitRmb");
  const inUnitUsd = document.getElementById("inUnitUsd");
  const inTotalUsd = document.getElementById("inTotalUsd");
  const invStatus = document.getElementById("invStatus");
  const btnSaveInv = document.getElementById("btnSaveInv");

  function to2(n){
    const x = Number(n);
    return isFinite(x) ? x.toFixed(2) : "0.00";
  }

  function calcInv(){
    const fx = Number(inFx.value);
    const qty = Number(inQty.value);
    const ur = Number(inUnitRmb.value);

    let uu = 0;
    if (fx > 0) uu = ur / fx;
    const total = uu * (isFinite(qty) ? qty : 0);

    inUnitUsd.value = to2(uu);
    inTotalUsd.value = to2(total);

    const ready = document.getElementById("inDate").value
      && fx > 0
      && document.getElementById("inSku").value.trim()
      && document.getElementById("inWh").value
      && document.getElementById("inCat").value
      && qty > 0
      && ur >= 0;

    invStatus.innerHTML = ready
      ? '<span class="dot ok"></span><span>Ready</span>'
      : '<span class="dot err"></span><span>Not ready</span>';
    btnSaveInv.disabled = !ready;
  }

  async function saveInv(){
    showErr("");
    const payload = {
      action:"inventory_in_create",
      date: document.getElementById("inDate").value,
      fx_rmb_usd: Number(inFx.value),
      sku: document.getElementById("inSku").value.trim(),
      warehouse: document.getElementById("inWh").value,
      prod_cat: document.getElementById("inCat").value,
      prod_size: document.getElementById("inSize").value,
      prod_color: document.getElementById("inColor").value,
      qty: Number(inQty.value),
      unit_rmb: Number(inUnitRmb.value),
      unit_usd: Number(inUnitUsd.value),
      total_usd: Number(inTotalUsd.value),
      note: document.getElementById("inNote").value.trim()
    };
    const r = await apiPost(payload);
    if (!r.ok) throw new Error(r.error || "Save failed");
    alert("Saved Inventory IN: " + r.inv_in_id);
  }

  function clearInv(){
    ["inDate","inSku","inNote"].forEach(id=>document.getElementById(id).value="");
    ["inFx","inQty","inUnitRmb"].forEach(id=>document.getElementById(id).value="");
    ["inWh","inCat","inSize","inColor"].forEach(id=>document.getElementById(id).value="");
    calcInv();
  }

  // ===== Sales items dynamic rows =====
  const itemsBody = document.querySelector("#itemsTable tbody");
  const soTotalEl = document.getElementById("soTotal");
  const lastOrderIdEl = document.getElementById("lastOrderId");
  let lastOrderId = "";

  function makeItemRow(){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="siSku" placeholder="SKU"></td>
      <td><input class="siName" placeholder="Product"></td>
      <td><input class="siQty" inputmode="decimal" placeholder="0"></td>
      <td><input class="siUnit" inputmode="decimal" placeholder="0.00"></td>
      <td><input class="siLine" readonly></td>
      <td><button class="btn gray siDel" type="button">Remove</button></td>
    `;
    const qty = tr.querySelector(".siQty");
    const unit = tr.querySelector(".siUnit");
    const line = tr.querySelector(".siLine");
    function calcLine(){
      const q = Number(qty.value);
      const u = Number(unit.value);
      const t = (isFinite(q)?q:0) * (isFinite(u)?u:0);
      line.value = to2(t);
      calcOrderTotal();
    }
    qty.addEventListener("input", calcLine);
    unit.addEventListener("input", calcLine);
    tr.querySelector(".siDel").onclick = ()=>{
      tr.remove();
      calcOrderTotal();
    };
    itemsBody.appendChild(tr);
  }

  function calcOrderTotal(){
    let sum = 0;
    itemsBody.querySelectorAll(".siLine").forEach(inp=>{
      sum += Number(inp.value || 0);
    });
    soTotalEl.textContent = to2(sum);
  }

  async function saveOrderAndItems(){
    showErr("");
    // Create order
    const orderPayload = {
      action:"sales_order_create",
      date: document.getElementById("soDate").value,
      customer_name: document.getElementById("soCust").value.trim(),
      telephone: document.getElementById("soTel").value.trim(),
      customer_address: document.getElementById("soAddr").value.trim(),
      delivery_company: document.getElementById("soDelivery").value,
      currency: document.getElementById("soCur").value,
      note: document.getElementById("soNote").value.trim(),
      status: document.getElementById("soStatus").value,
      paid_status: document.getElementById("soPaid").value,
      created_by: "", prepared_by: ""
    };

    const or = await apiPost(orderPayload);
    if (!or.ok) throw new Error(or.error || "Order save failed");
    lastOrderId = or.order_id;
    lastOrderIdEl.textContent = lastOrderId;

    // Items
    const rows = [...itemsBody.querySelectorAll("tr")];
    if (rows.length === 0) throw new Error("Add at least 1 item row");

    for (const tr of rows){
      const sku = tr.querySelector(".siSku").value.trim();
      const name = tr.querySelector(".siName").value.trim();
      const qty = Number(tr.querySelector(".siQty").value);
      const unit = Number(tr.querySelector(".siUnit").value);
      const line = Number(tr.querySelector(".siLine").value);
      if (!sku && !name) continue;
      const ir = await apiPost({
        action:"sales_item_add",
        order_id:lastOrderId,
        sku, product_name:name,
        qty, unit_price:unit, line_total:line
      });
      if (!ir.ok) throw new Error(ir.error || "Item save failed");
    }

    alert("Saved order " + lastOrderId + " with items.");
  }

  function clearSales(){
    ["soDate","soCust","soTel","soAddr","soNote"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("soCur").value="USD";
    document.getElementById("soStatus").value="Ordered";
    document.getElementById("soPaid").value="Not received";
    document.getElementById("soDelivery").value="";
    itemsBody.innerHTML = "";
    makeItemRow();
    calcOrderTotal();
  }

  async function recordCash(){
    showErr("");
    if (!lastOrderId) {
      alert("Save the order first so we can link cash to the order_id.");
      return;
    }
    const r = await apiPost({
      action:"cash_record",
      date: document.getElementById("cashDate").value,
      ref_type: "SALES",
      ref_id: lastOrderId,
      direction: document.getElementById("cashDir").value,
      amount: Number(document.getElementById("cashAmt").value),
      currency: document.getElementById("cashCur").value,
      fx_khr_usd: Number(document.getElementById("cashFx").value),
      note: document.getElementById("cashNote").value.trim()
    });
    if (!r.ok) throw new Error(r.error || "Cash record failed");
    alert("Cash recorded: " + r.cash_id);
  }

  // ===== Expenses =====
  async function saveExpense(){
    showErr("");
    const r = await apiPost({
      action:"expense_create",
      date: document.getElementById("exDate").value,
      exp_cat: document.getElementById("exCat").value,
      amount: Number(document.getElementById("exAmt").value),
      currency: document.getElementById("exCur").value,
      fx_khr_usd: Number(document.getElementById("exFx").value),
      note: document.getElementById("exNote").value.trim()
    });
    if (!r.ok) throw new Error(r.error || "Expense failed");
    alert("Expense saved: " + r.exp_id);
  }

  function clearExp(){
    ["exDate","exAmt","exFx","exNote"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("exCat").value="";
    document.getElementById("exCur").value="USD";
  }

  // ===== Dashboard minimal draw =====
  function drawBars(canvas, labels, values){
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height = canvas.clientHeight;
    ctx.clearRect(0,0,w,h);

    const pad = 30;
    const max = Math.max(1, ...values);
    const barW = (w - pad*2) / values.length;

    ctx.font = "12px system-ui";
    ctx.fillStyle = "#0f172a";

    values.forEach((v, i)=>{
      const bh = (h - pad*2) * (v/max);
      const x = pad + i*barW + 10;
      const y = h - pad - bh;

      // bar
      ctx.fillStyle = "rgba(37,99,235,.25)";
      ctx.fillRect(x, y, barW-20, bh);

      // label
      ctx.fillStyle = "#64748b";
      ctx.fillText(labels[i], x, h - 10);

      // value
      ctx.fillStyle = "#0f172a";
      ctx.fillText(String(v.toFixed(0)), x, y - 6);
    });
  }

  function dashRefresh(){
    // For now, lightweight placeholder (no heavy sheet reads).
    // Next step: add endpoints to fetch totals between dates.
    const cashIn = 0, cashOut = 0, exp = 0;
    document.getElementById("mCashIn").textContent = cashIn;
    document.getElementById("mCashOut").textContent = cashOut;
    document.getElementById("mExp").textContent = exp;
    drawBars(document.getElementById("dashChart"), ["Cash IN","Cash OUT","Expenses"], [cashIn,cashOut,exp]);
  }

  // ===== Init =====
  buildTabs();

  // load saved api url
  const saved = localStorage.getItem("ERP_API_URL") || "";
  apiUrlEl.value = saved || "";

  document.getElementById("btnPing").onclick = async ()=>{
    try{
      showErr("");
      saveApiUrl();
      setConn(false, "Checking...");
      const r = await apiGet("ping");
      if (!r.ok) throw new Error(r.error || "Ping failed");
      setConn(true, "Connected (ping ok)");
    }catch(e){
      setConn(false, "Ping failed");
      showErr(String(e));
    }
  };

  document.getElementById("btnLists").onclick = async ()=>{
    try{
      saveApiUrl();
      await reloadLists();
    }catch(e){
      setConn(false, "Lists failed");
      showErr(String(e));
    }
  };

  // + Add buttons
  document.getElementById("addWh").onclick = ()=>quickAdd("LOCATION");
  document.getElementById("addCat").onclick = ()=>quickAdd("PROD_CAT");
  document.getElementById("addSize").onclick = ()=>quickAdd("PROD_SIZE");
  document.getElementById("addColor").onclick = ()=>quickAdd("PROD_COLOR");
  document.getElementById("addDelivery").onclick = ()=>quickAdd("DELIVERY_CO");
  document.getElementById("addExpCat").onclick = ()=>quickAdd("EXP_CAT");

  // inventory listeners
  ["inFx","inQty","inUnitRmb","inDate","inSku","inWh","inCat","inSize","inColor"].forEach(id=>{
    document.getElementById(id).addEventListener("input", calcInv);
    document.getElementById(id).addEventListener("change", calcInv);
  });

  document.getElementById("btnSaveInv").onclick = async ()=>{
    try{ await saveInv(); }catch(e){ showErr(String(e)); }
  };
  document.getElementById("btnClearInv").onclick = clearInv;

  // sales
  document.getElementById("addItemRow").onclick = makeItemRow;
  document.getElementById("btnCreateOrder").onclick = async ()=>{
    try{ await saveOrderAndItems(); }catch(e){ showErr(String(e)); }
  };
  document.getElementById("btnClearSales").onclick = clearSales;
  document.getElementById("btnCash").onclick = async ()=>{
    try{ await recordCash(); }catch(e){ showErr(String(e)); }
  };

  // expenses
  document.getElementById("btnExp").onclick = async ()=>{
    try{ await saveExpense(); }catch(e){ showErr(String(e)); }
  };
  document.getElementById("btnClearExp").onclick = clearExp;

  // dashboard
  document.getElementById("btnDash").onclick = dashRefresh;

  // Default values
  makeItemRow();
  calcInv();
  dashRefresh();
</script>
</body>
</html>
