<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; --card:#f9fafb; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--t); background:var(--bg); }
    header { padding:14px 16px; border-bottom:1px solid var(--b); position:sticky; top:0; background:#fff; z-index:10; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab { border:1px solid var(--b); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; }
    .tab.active { background:var(--card); }
    main { padding:16px; max-width:1100px; margin:0 auto; }
    .card { border:1px solid var(--b); background:var(--card); border-radius:14px; padding:14px; margin:12px 0; }
    label { font-size:12px; color:var(--m); display:block; margin-bottom:4px; }
    input, select, textarea {
      width:100%; box-sizing:border-box; padding:10px; border:1px solid var(--b);
      border-radius:10px; background:#fff; font-size:14px;
    }
    textarea { min-height:70px; resize:vertical; }
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr;} }
    .btn { padding:10px 12px; border:1px solid var(--b); background:#fff; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .muted { color:var(--m); font-size:12px; }
    .ok { color:#065f46; font-weight:700; }
    .bad { color:#991b1b; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; }
    .kpi .box { background:#fff; border:1px solid var(--b); border-radius:12px; padding:10px 12px; min-width:180px; }
    .kpi .v { font-size:18px; font-weight:800; }
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between;">
    <div>
      <div style="font-weight:900;">Internal ERP</div>
      <div class="muted">Stable | Lists are read-only (edit in Google Sheet → Lists tab)</div>
    </div>
    <div class="row">
      <button class="btn" id="btnReload">Reload Lists</button>
      <span class="muted mono" id="apiStatus">API: -</span>
    </div>
  </div>
  <div class="tabs" style="margin-top:10px;">
    <button class="tab active" data-tab="inv">Inventory IN</button>
    <button class="tab" data-tab="sales">Sales</button>
    <button class="tab" data-tab="exp">Expenses</button>
    <button class="tab" data-tab="dash">Dashboard</button>
  </div>
</header>

<main>
  <div class="card">
    <label>Apps Script Web App URL (fixed)</label>
    <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbxyc8ebqei-l767WdTJ5qgz1bqj9ZCVsQaegVobmzuUVzXepdqeUcmUPvbuW3OhazYh/exec" disabled />
  </div>

  <section id="tab-inv">
    <div class="card">
      <div style="font-weight:900; margin-bottom:10px;">Inventory IN</div>
      <div class="grid">
        <div><label>Date (yyyy-mm-dd)</label><input id="inv_date" placeholder="2026-02-07"></div>
        <div><label>Warehouse / Location</label><select id="inv_location"></select></div>
        <div><label>Product Category</label><select id="inv_prodcat"></select></div>
        <div><label>Product Name</label><input id="inv_product" placeholder="Name"></div>
        <div><label>Color</label><select id="inv_color"></select></div>
        <div><label>Size</label><select id="inv_size"></select></div>
        <div><label>Qty</label><input id="inv_qty" inputmode="decimal" placeholder="0"></div>
        <div><label>Unit Price (RMB)</label><input id="inv_unit_rmb" inputmode="decimal" placeholder="0.00"></div>
        <div><label>FX (RMB / USD)</label><input id="inv_fx" inputmode="decimal" placeholder="7.20"></div>
        <div><label>Unit Price (USD) auto</label><input id="inv_unit_usd" disabled></div>
        <div><label>Amount (USD) auto</label><input id="inv_amt_usd" disabled></div>
        <div><label>Note</label><input id="inv_note" placeholder=""></div>
      </div>
      <div class="row" style="margin-top:12px; justify-content:space-between;">
        <div class="muted">USD calc uses 2 decimals: unit_usd = unit_rmb / fx</div>
        <button class="btn primary" id="btnInvSave">Save Inventory IN</button>
      </div>
      <div class="muted mono" id="inv_result" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="tab-sales" style="display:none;">
    <div class="card">
      <div style="font-weight:900; margin-bottom:10px;">Sales</div>
      <div class="grid">
        <div><label>Order Date (yyyy-mm-dd)</label><input id="so_date" placeholder="2026-02-07"></div>
        <div><label>Warehouse / Location</label><select id="so_location"></select></div>
        <div><label>Customer</label><input id="so_customer" placeholder=""></div>
        <div><label>Delivery Company</label><select id="so_delivery"></select></div>
        <div><label>Currency</label><select id="so_currency"><option value="USD">USD</option><option value="KHR">KHR</option></select></div>
        <div><label>Cash Timing</label><select id="so_cash_timing"><option value="AFTER">AFTER delivery</option><option value="BEFORE">BEFORE delivery</option></select></div>
        <div><label>Paid Amount</label><input id="so_paid" inputmode="decimal" placeholder="0.00"></div>
        <div><label>Note</label><input id="so_note" placeholder=""></div>
      </div>

      <div style="margin-top:12px; font-weight:800;">Item (single item for stability)</div>
      <div class="grid" style="margin-top:8px;">
        <div><label>Product Category</label><select id="si_prodcat"></select></div>
        <div><label>Product</label><input id="si_product" placeholder=""></div>
        <div><label>Color</label><select id="si_color"></select></div>
        <div><label>Size</label><select id="si_size"></select></div>
        <div><label>Qty</label><input id="si_qty" inputmode="decimal" placeholder="0"></div>
        <div><label>Unit Price</label><input id="si_unit" inputmode="decimal" placeholder="0.00"></div>
        <div><label>Line Total auto</label><input id="si_total" disabled></div>
        <div></div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:space-between;">
        <div class="muted">Total = qty × unit price. Payment status auto from paid vs total.</div>
        <button class="btn primary" id="btnSalesSave">Save Sale</button>
      </div>
      <div class="muted mono" id="sales_result" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="tab-exp" style="display:none;">
    <div class="card">
      <div style="font-weight:900; margin-bottom:10px;">Expenses</div>
      <div class="grid">
        <div><label>Date (yyyy-mm-dd)</label><input id="ex_date" placeholder="2026-02-07"></div>
        <div><label>Warehouse / Location</label><select id="ex_location"></select></div>
        <div><label>Expense Category</label><select id="ex_cat"></select></div>
        <div><label>Currency</label><select id="ex_currency"><option value="USD">USD</option><option value="KHR">KHR</option></select></div>
        <div><label>Amount</label><input id="ex_amount" inputmode="decimal" placeholder="0.00"></div>
        <div><label>Note</label><input id="ex_note" placeholder=""></div>
      </div>
      <div class="row" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn primary" id="btnExpSave">Save Expense</button>
      </div>
      <div class="muted mono" id="exp_result" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="tab-dash" style="display:none;">
    <div class="card">
      <div style="font-weight:900; margin-bottom:10px;">Dashboard</div>
      <div class="grid">
        <div><label>Start Date (yyyy-mm-dd)</label><input id="d_start" placeholder="2026-02-01"></div>
        <div><label>End Date (yyyy-mm-dd)</label><input id="d_end" placeholder="2026-02-07"></div>
        <div style="align-self:end;"><button class="btn primary" id="btnDashLoad">Load</button></div>
        <div></div>
      </div>
      <div class="kpi" style="margin-top:12px;">
        <div class="box"><div class="muted">Inventory IN (USD)</div><div class="v" id="k_inv">-</div></div>
        <div class="box"><div class="muted">Sales Total</div><div class="v" id="k_sales">-</div></div>
        <div class="box"><div class="muted">Sales Paid</div><div class="v" id="k_paid">-</div></div>
        <div class="box"><div class="muted">Expenses</div><div class="v" id="k_exp">-</div></div>
      </div>
      <div class="muted mono" id="dash_result" style="margin-top:10px;"></div>
    </div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function fmt2(n){
    const x = Number(n);
    if (!isFinite(x)) return "0.00";
    return x.toFixed(2);
  }

  async function apiCall(action, payload = {}, method = "POST") {
    const url = $("apiUrl").value.trim();
    const params = new URLSearchParams({ action, ...payload });

    let res, text;
    if (method === "GET") {
      res = await fetch(url + "?" + params.toString());
      text = await res.text();
    } else {
      res = await fetch(url, { method: "POST", body: params });
      text = await res.text();
    }

    let json;
    try { json = JSON.parse(text); }
    catch (e) { json = { ok:false, error:"BAD_JSON", raw:text }; }
    if (!json.ok) throw json;
    return json;
  }

  let LISTS = {};

  function bindSelect(id, arr){
    const el = $(id);
    el.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "";
    el.appendChild(opt0);
    (arr || []).forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      el.appendChild(o);
    });
  }

  async function loadLists() {
    $("apiStatus").textContent = "API: connecting...";
    $("apiStatus").className = "muted mono";
    try {
      const r = await apiCall("get_lists", {}, "GET");
      LISTS = r.data || {};

      bindSelect("inv_location", LISTS.LOCATION || []);
      bindSelect("so_location", LISTS.LOCATION || []);
      bindSelect("ex_location", LISTS.LOCATION || []);

      bindSelect("inv_prodcat", LISTS.PROD_CAT || []);
      bindSelect("si_prodcat", LISTS.PROD_CAT || []);

      bindSelect("inv_color", LISTS.PROD_COLOR || LISTS.COLOR || []);
      bindSelect("si_color", LISTS.PROD_COLOR || LISTS.COLOR || []);

      bindSelect("inv_size", LISTS.PROD_SIZE || LISTS.SIZE || []);
      bindSelect("si_size", LISTS.PROD_SIZE || LISTS.SIZE || []);

      bindSelect("ex_cat", LISTS.EXP_CAT || []);
      bindSelect("so_delivery", LISTS.DELIVERY_COMPANY || LISTS.DELIVERY || []);

      $("apiStatus").textContent = "API: OK";
      $("apiStatus").className = "muted mono ok";
    } catch (e) {
      console.error(e);
      $("apiStatus").textContent = "API: ERROR";
      $("apiStatus").className = "muted mono bad";
      alert("API ERROR:\n" + JSON.stringify(e).slice(0, 600));
    }
  }

  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      $("tab-inv").style.display = (t === "inv") ? "" : "none";
      $("tab-sales").style.display = (t === "sales") ? "" : "none";
      $("tab-exp").style.display = (t === "exp") ? "" : "none";
      $("tab-dash").style.display = (t === "dash") ? "" : "none";
    });
  });

  function calcInv(){
    const qty = Number($("inv_qty").value || 0);
    const unitRmb = Number($("inv_unit_rmb").value || 0);
    const fx = Number($("inv_fx").value || 0);
    const unitUsd = fx > 0 ? (unitRmb / fx) : 0;
    $("inv_unit_usd").value = fmt2(unitUsd);
    $("inv_amt_usd").value = fmt2(qty * unitUsd);
  }
  ["inv_qty","inv_unit_rmb","inv_fx"].forEach(id => $(id).addEventListener("input", calcInv));

  function calcSale(){
    const qty = Number($("si_qty").value || 0);
    const unit = Number($("si_unit").value || 0);
    $("si_total").value = fmt2(qty * unit);
  }
  ["si_qty","si_unit"].forEach(id => $(id).addEventListener("input", calcSale));

  $("btnInvSave").addEventListener("click", async () => {
    $("inv_result").textContent = "Saving...";
    try {
      const payload = {
        date: $("inv_date").value.trim(),
        location: $("inv_location").value.trim(),
        prod_cat: $("inv_prodcat").value.trim(),
        product: $("inv_product").value.trim(),
        color: $("inv_color").value.trim(),
        size: $("inv_size").value.trim(),
        qty: $("inv_qty").value.trim(),
        unit_rmb: $("inv_unit_rmb").value.trim(),
        fx: $("inv_fx").value.trim(),
        note: $("inv_note").value.trim(),
      };
      const r = await apiCall("inventory_in", payload, "POST");
      $("inv_result").textContent = "OK: " + JSON.stringify(r.data);
    } catch(e) {
      console.error(e);
      $("inv_result").textContent = "ERROR: " + JSON.stringify(e);
    }
  });

  $("btnSalesSave").addEventListener("click", async () => {
    $("sales_result").textContent = "Saving...";
    try {
      const items = [{
        prod_cat: $("si_prodcat").value.trim(),
        product: $("si_product").value.trim(),
        color: $("si_color").value.trim(),
        size: $("si_size").value.trim(),
        qty: $("si_qty").value.trim(),
        unit_price: $("si_unit").value.trim(),
      }];

      const payload = {
        order_date: $("so_date").value.trim(),
        location: $("so_location").value.trim(),
        customer: $("so_customer").value.trim(),
        delivery_company: $("so_delivery").value.trim(),
        currency: $("so_currency").value.trim(),
        cash_timing: $("so_cash_timing").value.trim(),
        paid_amount: $("so_paid").value.trim(),
        note: $("so_note").value.trim(),
        items: JSON.stringify(items),
      };

      const r = await apiCall("sales", payload, "POST");
      $("sales_result").textContent = "OK: " + JSON.stringify(r.data);
    } catch(e) {
      console.error(e);
      $("sales_result").textContent = "ERROR: " + JSON.stringify(e);
    }
  });

  $("btnExpSave").addEventListener("click", async () => {
    $("exp_result").textContent = "Saving...";
    try {
      const payload = {
        date: $("ex_date").value.trim(),
        location: $("ex_location").value.trim(),
        exp_cat: $("ex_cat").value.trim(),
        currency: $("ex_currency").value.trim(),
        amount: $("ex_amount").value.trim(),
        note: $("ex_note").value.trim(),
      };
      const r = await apiCall("expenses", payload, "POST");
      $("exp_result").textContent = "OK: " + JSON.stringify(r.data);
    } catch(e) {
      console.error(e);
      $("exp_result").textContent = "ERROR: " + JSON.stringify(e);
    }
  });

  $("btnDashLoad").addEventListener("click", async () => {
    $("dash_result").textContent = "Loading...";
    try {
      const payload = { start_date: $("d_start").value.trim(), end_date: $("d_end").value.trim() };
      const r = await apiCall("dashboard", payload, "GET");
      const d = r.data || {};
      $("k_inv").textContent = fmt2(d.inventory_in_usd);
      $("k_sales").textContent = fmt2(d.sales_total);
      $("k_paid").textContent = fmt2(d.sales_paid);
      $("k_exp").textContent = fmt2(d.expenses_total);
      $("dash_result").textContent = "OK: " + JSON.stringify(d);
    } catch(e) {
      console.error(e);
      $("dash_result").textContent = "ERROR: " + JSON.stringify(e);
    }
  });

  $("btnReload").addEventListener("click", loadLists);

  loadLists();
</script>
</body>
</html>
