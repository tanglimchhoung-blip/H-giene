<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e6e8ee;
      --muted:#6b7280;
      --text:#111827;
      --blue:#2563eb;
      --blue-2:#1d4ed8;
      --pill:#f3f4f6;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:var(--bg);
    }
    .wrap{
      max-width: 1100px;
      margin: 18px auto 42px;
      padding: 0 14px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding: 18px 18px 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .brand h1{
      margin:0;
      font-size: 26px;
      line-height: 1.1;
      letter-spacing: .2px;
    }
    .brand .sub{
      margin-top:6px;
      color:var(--muted);
      font-size: 13px;
    }
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-size:14px;
      color:#111827;
      user-select:none;
    }
    .tab.active{
      border-color:#111827;
      box-shadow: 0 0 0 3px rgba(17,24,39,.05);
      font-weight:600;
    }

    .card{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:var(--card);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .title{
      font-size: 20px;
      margin:0 0 10px 0;
    }
    .hint{
      color:var(--muted);
      font-size: 13px;
      margin: 0 0 14px 0;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted);}
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      font-size: 15px;
      background:#fff;
    }
    textarea{min-height: 90px; resize: vertical;}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
      align-items:center;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding: 11px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size: 14px;
    }
    .btn.primary{
      background: var(--blue);
      border-color: var(--blue);
      color:#fff;
    }
    .btn.primary:hover{ background: var(--blue-2); }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: #fff;
      color: var(--muted);
      font-size: 13px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: #9ca3af;
      display:inline-block;
    }

    .listbox{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .listbox .head{
      padding:12px 14px;
      background:#fafafa;
      border-bottom:1px solid var(--border);
      font-weight:700;
      font-size: 13px;
      color:#374151;
    }
    .listbox .body{
      padding:12px 14px;
      color:var(--muted);
      font-size: 13px;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      background: #111827;
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      display:none;
      max-width: calc(100vw - 20px);
    }

    /* Responsive */
    @media (max-width: 820px){
      .topbar{flex-direction:column; align-items:stretch;}
      .tabs{justify-content:flex-start;}
      .wrap{margin-top: 12px;}
    }
    @media (max-width: 640px){
      .card{padding:14px;}
      input, select, textarea{padding: 11px 11px; font-size: 15px;}
      .tab{padding:9px 12px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Internal ERP</h1>
        <div class="sub">Simple • Finance-first • FIFO-ready</div>
      </div>
      <div class="tabs" id="tabs">
        <button class="tab" data-view="dash">Dashboard</button>
        <button class="tab" data-view="inv">Inventory IN</button>
        <button class="tab" data-view="sales">Sales</button>
        <button class="tab" data-view="exp">Expenses</button>
        <button class="tab" data-view="rep">Reports</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section class="card" id="view-dash" style="display:none;">
      <h2 class="title">Dashboard</h2>
      <p class="hint">Quick view by date range. (You can add charts later after data is stable.)</p>

      <div class="grid">
        <div class="field" style="grid-column: span 6;">
          <label>From date</label>
          <input id="dash_from" type="date" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>To date</label>
          <input id="dash_to" type="date" />
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btn_dash">Refresh Dashboard</button>
        <span class="badge"><span class="dot"></span><span id="dash_status">Ready</span></span>
      </div>

      <div class="listbox" style="margin-top:16px;">
        <div class="head">Summary</div>
        <div class="body" id="dash_body">Load from sheet later.</div>
      </div>
    </section>

    <!-- INVENTORY IN -->
    <section class="card" id="view-inv" style="display:none;">
      <h2 class="title">Inventory IN</h2>
      <p class="hint">FX fixed to 2 decimals. Unit cost USD = RMB unit price ÷ FX.</p>

      <div class="grid">
        <div class="field" style="grid-column: span 6;">
          <label>Date received</label>
          <input id="inv_date" type="date" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>FX RMB → USD (2 decimals)</label>
          <input id="inv_fx" inputmode="decimal" placeholder="e.g. 7.20" />
        </div>

        <div class="field" style="grid-column: span 4;">
          <label>SKU</label>
          <input id="inv_sku" placeholder="SKU" />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Product category</label>
          <select id="inv_cat"></select>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Warehouse location</label>
          <select id="inv_loc"></select>
        </div>

        <div class="field" style="grid-column: span 4;">
          <label>Size (optional)</label>
          <select id="inv_size"></select>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Color (optional)</label>
          <select id="inv_color"></select>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Qty received</label>
          <input id="inv_qty" inputmode="numeric" placeholder="0" />
        </div>

        <div class="field" style="grid-column: span 4;">
          <label>Unit price (RMB)</label>
          <input id="inv_rmb" inputmode="decimal" placeholder="0.00" />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Unit cost (USD) (auto)</label>
          <input id="inv_usd_unit" disabled />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Total cost (USD) (auto)</label>
          <input id="inv_usd_total" disabled />
        </div>

        <div class="field" style="grid-column: span 12;">
          <label>Note</label>
          <textarea id="inv_note" placeholder="Optional note"></textarea>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btn_inv_save">Save Inventory IN</button>
        <button class="btn" id="btn_inv_clear">Clear</button>
        <span class="badge"><span class="dot"></span><span id="inv_status">Ready</span></span>
      </div>

      <div class="listbox">
        <div class="head">Last Inventory IN (latest 20)</div>
        <div class="body" id="inv_recent">Load from sheet later.</div>
      </div>
    </section>

    <!-- SALES -->
    <section class="card" id="view-sales" style="display:none;">
      <h2 class="title">Sales</h2>
      <p class="hint"><b>Mr/Ms A</b>: Drop order. • <b>Mr/Ms B</b>: Prepare. • Payment can be marked only after Delivered/Completed.</p>

      <div class="grid">
        <div class="field" style="grid-column: span 6;">
          <label>Date</label>
          <input id="s_date" type="date" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>Customer name</label>
          <input id="s_customer" placeholder="Customer name" />
        </div>

        <div class="field" style="grid-column: span 6;">
          <label>Telephone number</label>
          <input id="s_phone" inputmode="tel" placeholder="e.g. 012345678" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>Customer address</label>
          <input id="s_address" placeholder="Street / unit / landmark" />
        </div>

        <div class="field" style="grid-column: span 4;">
          <label>Currency</label>
          <select id="s_ccy">
            <option value="USD">USD</option>
            <option value="KHR">KHR</option>
          </select>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>FX KHR → USD (if KHR)</label>
          <input id="s_fx" inputmode="decimal" placeholder="0" />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Order by (Mr/Ms A)</label>
          <input id="s_byA" placeholder="Mr A / Ms A" />
        </div>

        <div class="field" style="grid-column: span 4;">
          <label>SKU</label>
          <input id="s_sku" placeholder="SKU" />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Product</label>
          <select id="s_cat"></select>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Qty</label>
          <input id="s_qty" inputmode="numeric" value="1" />
        </div>

        <div class="field" style="grid-column: span 4;">
          <label>Unit price</label>
          <input id="s_price" inputmode="decimal" value="0.00" />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Line total (auto)</label>
          <input id="s_total" disabled />
        </div>
        <div class="field" style="grid-column: span 4;">
          <label>Status</label>
          <select id="s_status">
            <option value="Preparation">Preparation</option>
            <option value="Delivered">Delivered</option>
            <option value="Completed">Completed</option>
          </select>
        </div>

        <div class="field" style="grid-column: span 6;">
          <label>Note</label>
          <input id="s_note" placeholder="Optional note" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>Paid?</label>
          <select id="s_paid">
            <option value="Not received">Not received</option>
            <option value="Received">Received</option>
          </select>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btn_dropA">Drop Order (A)</button>
        <button class="btn" id="btn_sales_clear">Clear</button>
        <span class="badge"><span class="dot"></span><span id="s_badge">Ready</span></span>
        <span class="badge" id="paid_hint">Paid disabled until Delivered/Completed</span>
      </div>

      <div class="listbox">
        <div class="head">Recent Sales (latest 20)</div>
        <div class="body" id="s_recent">Loading…</div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section class="card" id="view-exp" style="display:none;">
      <h2 class="title">Expenses</h2>
      <p class="hint">You can add your own expense categories later in the List tab (EXP_CAT).</p>

      <div class="grid">
        <div class="field" style="grid-column: span 6;">
          <label>Date</label>
          <input id="e_date" type="date" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>Category</label>
          <select id="e_cat"></select>
        </div>

        <div class="field" style="grid-column: span 6;">
          <label>Amount (USD)</label>
          <input id="e_amt" inputmode="decimal" placeholder="0.00" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>Note</label>
          <input id="e_note" placeholder="Optional note" />
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btn_exp_save">Save Expense</button>
        <button class="btn" id="btn_exp_clear">Clear</button>
        <span class="badge"><span class="dot"></span><span id="e_status">Ready</span></span>
      </div>

      <div class="listbox">
        <div class="head">Recent Expenses (latest 20)</div>
        <div class="body" id="e_recent">Load from sheet later.</div>
      </div>
    </section>

    <!-- REPORTS -->
    <section class="card" id="view-rep" style="display:none;">
      <h2 class="title">Reports</h2>
      <p class="hint">Select date range for reports (PnL / Balance Sheet later).</p>

      <div class="grid">
        <div class="field" style="grid-column: span 6;">
          <label>From date</label>
          <input id="r_from" type="date" />
        </div>
        <div class="field" style="grid-column: span 6;">
          <label>To date</label>
          <input id="r_to" type="date" />
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btn_rep">Load Reports</button>
        <span class="badge"><span class="dot"></span><span id="r_status">Ready</span></span>
      </div>

      <div class="grid" style="margin-top:14px;">
        <div class="listbox" style="grid-column: span 6;">
          <div class="head">PnL (summary)</div>
          <div class="body" id="rep_pnl">Load from sheet later.</div>
        </div>
        <div class="listbox" style="grid-column: span 6;">
          <div class="head">Balance Sheet (summary)</div>
          <div class="body" id="rep_bs">Load from sheet later.</div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // === SET YOUR APPS SCRIPT WEB APP URL HERE ===
    const API = "https://script.google.com/macros/s/AKfycbzgC6AqVVftlcvoetDa2aTVzdSbrK7FSJt7kpJCFDeHB7o7azG0Lh_yB4a4CBw1I-ML/exec";

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> t.style.display='none', 2400);
    }

    async function apiGet(params){
      const url = API + "?" + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:"GET" });
      const text = await res.text();
      try { return JSON.parse(text); } catch(e){ return { ok:false, error:"Non-JSON: " + text.slice(0,120) }; }
    }

    async function apiPost(payload){
      const res = await fetch(API, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      try { return JSON.parse(text); } catch(e){ return { ok:false, error:"Non-JSON: " + text.slice(0,120) }; }
    }

    // Tabs
    const views = ["dash","inv","sales","exp","rep"];
    function setView(v){
      for (const x of views){
        document.getElementById("view-"+x).style.display = (x===v) ? "block" : "none";
      }
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.view===v);
      });
      localStorage.setItem("erp_view", v);
    }
    document.getElementById("tabs").addEventListener("click", (e)=>{
      const btn = e.target.closest(".tab");
      if(!btn) return;
      setView(btn.dataset.view);
    });

    // Helpers
    function todayISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function to2(n){ return (isFinite(n) ? Number(n).toFixed(2) : "0.00"); }

    // Populate lists
    async function loadLists(){
      const j = await apiGet({ action:"lists" });
      if(!j.ok){ toast("List load failed: " + (j.error||"")); return; }
      const L = j.data || {};

      const setOptions = (sel, arr, allowBlank=true)=>{
        sel.innerHTML = "";
        if(allowBlank){
          const o = document.createElement("option");
          o.value = ""; o.textContent = "";
          sel.appendChild(o);
        }
        (arr||[]).forEach(v=>{
          const o = document.createElement("option");
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        });
      };

      setOptions(document.getElementById("inv_loc"), L.locations || [], false);
      setOptions(document.getElementById("e_cat"),  L.expCats   || [], false);

      setOptions(document.getElementById("inv_cat"),   L.prodCats   || [], false);
      setOptions(document.getElementById("inv_size"),  L.prodSizes  || [], true);
      setOptions(document.getElementById("inv_color"), L.prodColors || [], true);

      setOptions(document.getElementById("s_cat"), L.prodCats || [], false);
    }

    // Inventory IN calc
    function calcInv(){
      const fx = Number(document.getElementById("inv_fx").value || 0);
      const rmb = Number(document.getElementById("inv_rmb").value || 0);
      const qty = Number(document.getElementById("inv_qty").value || 0);
      if(fx>0){
        const unit = rmb / fx;
        document.getElementById("inv_usd_unit").value = to2(unit);
        document.getElementById("inv_usd_total").value = to2(unit * qty);
      } else {
        document.getElementById("inv_usd_unit").value = "";
        document.getElementById("inv_usd_total").value = "";
      }
    }

    // Sales calc + paid lock
    function calcSales(){
      const qty = Number(document.getElementById("s_qty").value || 0);
      const price = Number(document.getElementById("s_price").value || 0);
      document.getElementById("s_total").value = to2(qty * price);

      const st = document.getElementById("s_status").value;
      const paid = document.getElementById("s_paid");
      const allowed = (st==="Delivered" || st==="Completed");
      paid.disabled = !allowed;
      document.getElementById("paid_hint").style.opacity = allowed ? 0.3 : 1;
      if(!allowed) paid.value = "Not received";
    }

    // Save handlers (these must match your Code.gs actions)
    async function saveInventoryIn(){
      document.getElementById("inv_status").textContent = "Saving…";
      const payload = {
        action:"inventory_in_create",
        date: document.getElementById("inv_date").value,
        fx: Number(document.getElementById("inv_fx").value||0).toFixed(2),
        sku: document.getElementById("inv_sku").value.trim(),
        prodCat: document.getElementById("inv_cat").value,
        prodSize: document.getElementById("inv_size").value,
        prodColor: document.getElementById("inv_color").value,
        location: document.getElementById("inv_loc").value,
        qty: Number(document.getElementById("inv_qty").value||0),
        unitRmb: Number(document.getElementById("inv_rmb").value||0),
        note: document.getElementById("inv_note").value.trim()
      };
      const j = await apiPost(payload);
      if(j.ok){
        toast("Saved Inventory IN");
        document.getElementById("inv_status").textContent = "Saved";
      } else {
        toast("Save failed: " + (j.error||""));
        document.getElementById("inv_status").textContent = "Failed";
      }
    }

    async function saveExpense(){
      document.getElementById("e_status").textContent = "Saving…";
      const payload = {
        action:"expense_create",
        date: document.getElementById("e_date").value,
        category: document.getElementById("e_cat").value,
        amountUsd: Number(document.getElementById("e_amt").value||0),
        note: document.getElementById("e_note").value.trim()
      };
      const j = await apiPost(payload);
      if(j.ok){
        toast("Saved expense");
        document.getElementById("e_status").textContent = "Saved";
      } else {
        toast("Save failed: " + (j.error||""));
        document.getElementById("e_status").textContent = "Failed";
      }
    }

    async function dropOrderA(){
      document.getElementById("s_badge").textContent = "Saving…";
      const payload = {
        action:"sales_create",
        date: document.getElementById("s_date").value,
        customerName: document.getElementById("s_customer").value.trim(),
        telephone: document.getElementById("s_phone").value.trim(),
        customerAddress: document.getElementById("s_address").value.trim(),
        currency: document.getElementById("s_ccy").value,
        fxKhrUsd: Number(document.getElementById("s_fx").value||0),
        orderedBy: document.getElementById("s_byA").value.trim(),
        sku: document.getElementById("s_sku").value.trim(),
        product: document.getElementById("s_cat").value,
        qty: Number(document.getElementById("s_qty").value||0),
        unitPrice: Number(document.getElementById("s_price").value||0),
        note: document.getElementById("s_note").value.trim(),
        status: document.getElementById("s_status").value,
        paid: (document.getElementById("s_paid").value === "Received")
      };
      const j = await apiPost(payload);
      if(j.ok){
        toast("Order dropped (A)");
        document.getElementById("s_badge").textContent = "Saved";
      } else {
        toast("Save failed: " + (j.error||""));
        document.getElementById("s_badge").textContent = "Failed";
      }
    }

    // Clear buttons
    function clearInventory(){
      document.getElementById("inv_sku").value="";
      document.getElementById("inv_cat").value="";
      document.getElementById("inv_size").value="";
      document.getElementById("inv_color").value="";
      document.getElementById("inv_qty").value="";
      document.getElementById("inv_rmb").value="";
      document.getElementById("inv_note").value="";
      calcInv();
      document.getElementById("inv_status").textContent="Ready";
    }
    function clearExpense(){
      document.getElementById("e_amt").value="";
      document.getElementById("e_note").value="";
      document.getElementById("e_status").textContent="Ready";
    }
    function clearSales(){
      document.getElementById("s_sku").value="";
      document.getElementById("s_cat").value="";
      document.getElementById("s_qty").value="1";
      document.getElementById("s_price").value="0.00";
      document.getElementById("s_note").value="";
      document.getElementById("s_status").value="Preparation";
      document.getElementById("s_paid").value="Not received";
      calcSales();
      document.getElementById("s_badge").textContent="Ready";
    }

    // Init
    (async function init(){
      // default dates
      const t = todayISO();
      document.getElementById("inv_date").value = t;
      document.getElementById("s_date").value = t;
      document.getElementById("e_date").value = t;
      document.getElementById("dash_from").value = t;
      document.getElementById("dash_to").value = t;
      document.getElementById("r_from").value = t;
      document.getElementById("r_to").value = t;

      // wire calc
      ["inv_fx","inv_rmb","inv_qty"].forEach(id=> document.getElementById(id).addEventListener("input", calcInv));
      ["s_qty","s_price","s_status"].forEach(id=> document.getElementById(id).addEventListener("input", calcSales));
      document.getElementById("s_paid").addEventListener("change", calcSales);

      // wire actions
      document.getElementById("btn_inv_save").addEventListener("click", saveInventoryIn);
      document.getElementById("btn_inv_clear").addEventListener("click", clearInventory);

      document.getElementById("btn_exp_save").addEventListener("click", saveExpense);
      document.getElementById("btn_exp_clear").addEventListener("click", clearExpense);

      document.getElementById("btn_dropA").addEventListener("click", dropOrderA);
      document.getElementById("btn_sales_clear").addEventListener("click", clearSales);

      // load lists
      await loadLists();
      calcInv();
      calcSales();

      // default view
      const v = localStorage.getItem("erp_view") || "sales";
      setView(v);

      // quick ping check
      const ping = await apiGet({ action:"ping" });
      if(!ping.ok) toast("API ping failed: " + (ping.error||""));
    })();
  </script>
</body>
</html>
