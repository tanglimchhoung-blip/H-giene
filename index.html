<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Internal ERP</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
      --card:#ffffff; --shadow:0 8px 24px rgba(0,0,0,.06);
      --btn:#111827; --btnfg:#ffffff; --danger:#b91c1c;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 18px}
    .tab{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .tab.active{outline:2px solid #111827}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:14px 0}
    .card h2{margin:0 0 12px;font-size:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .field{grid-column:span 3}
    .field.span4{grid-column:span 4}
    .field.span6{grid-column:span 6}
    .field.span12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;
      font-size:14px;outline:none;background:#fff;color:var(--fg)
    }
    textarea{min-height:40px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{
      border:0;background:var(--btn);color:var(--btnfg);padding:10px 14px;border-radius:12px;
      font-weight:700;cursor:pointer
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#fff;color:var(--fg);border:1px solid var(--line)}
    .btn.danger{background:var(--danger)}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    .status{font-size:12px;color:var(--muted)}
    .ok{color:#047857;font-weight:700}
    .bad{color:#b91c1c;font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px;text-align:left;vertical-align:middle}
    th{background:#f9fafb;font-weight:800}
    tr:last-child td{border-bottom:0}
    .small{font-size:12px;color:var(--muted)}
    .right{text-align:right}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    @media (max-width:900px){
      .field,.field.span4,.field.span6{grid-column:span 12}
      header{align-items:flex-start;flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Internal ERP</h1>
        <div class="sub">Stable | Lists are read-only (edit in Google Sheet → Lists tab)</div>
      </div>
      <div class="status" id="apiStatus">API: <span class="bad">CHECKING…</span></div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="inv">Inventory IN</button>
      <button class="tab" data-tab="sales">Sales</button>
      <button class="tab" data-tab="exp">Expenses</button>
      <button class="tab" data-tab="dash">Dashboard</button>
    </div>

    <!-- Inventory IN -->
    <section id="tab-inv">
      <div class="card">
        <h2>Inventory IN</h2>
        <div class="grid">
          <div class="field span3">
            <label>Date (yyyy-mm-dd)</label>
            <input id="inv_date" type="date" />
          </div>
          <div class="field span3">
            <label>Warehouse / Location</label>
            <select id="inv_location"></select>
          </div>
          <div class="field span3">
            <label>Product Category</label>
            <select id="inv_prod_cat"></select>
          </div>
          <div class="field span3">
            <label>Product Name</label>
            <input id="inv_product" type="text" placeholder="Name" />
          </div>

          <div class="field span3">
            <label>Color</label>
            <select id="inv_color"></select>
          </div>
          <div class="field span3">
            <label>Size</label>
            <select id="inv_size"></select>
          </div>
          <div class="field span3">
            <label>Qty</label>
            <input id="inv_qty" type="number" step="1" min="0" value="0" />
          </div>
          <div class="field span3">
            <label>Unit Price (RMB)</label>
            <input id="inv_unit_rmb" type="number" step="0.01" min="0" value="0.00" />
          </div>

          <div class="field span3">
            <label>FX (RMB / USD)</label>
            <input id="inv_fx" type="number" step="0.01" min="0.01" value="7.20" />
          </div>
          <div class="field span3">
            <label>Unit Price (USD) auto</label>
            <input id="inv_unit_usd" type="text" readonly />
          </div>
          <div class="field span3">
            <label>Amount (USD) auto</label>
            <input id="inv_amount_usd" type="text" readonly />
          </div>
          <div class="field span3">
            <label>Note</label>
            <input id="inv_note" type="text" />
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="note">USD calc uses 2 decimals: unit_usd = unit_rmb / fx</div>
          <button class="btn" id="btnSaveInv">Save Inventory IN</button>
        </div>

        <div class="small" id="invMsg" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Sales -->
    <section id="tab-sales" style="display:none">
      <div class="card">
        <h2>Sales</h2>

        <div class="grid">
          <div class="field span3">
            <label>Order Date (yyyy-mm-dd)</label>
            <input id="so_date" type="date" />
          </div>
          <div class="field span3">
            <label>Warehouse / Location</label>
            <select id="so_location"></select>
          </div>
          <div class="field span3">
            <label>Customer</label>
            <input id="so_customer" type="text" placeholder="Customer name" />
          </div>
          <div class="field span3">
            <label>Delivery Company</label>
            <select id="so_delivery_company"></select>
          </div>

          <div class="field span3">
            <label>Currency</label>
            <select id="so_currency">
              <option value="USD">USD</option>
              <option value="KHR">KHR</option>
            </select>
          </div>
          <div class="field span3">
            <label>Cash Timing</label>
            <select id="so_cash_timing">
              <option value="BEFORE">BEFORE delivery</option>
              <option value="AFTER">AFTER delivery</option>
            </select>
          </div>
          <div class="field span3">
            <label>Paid Amount</label>
            <input id="so_paid" type="number" step="0.01" min="0" value="0.00" />
          </div>
          <div class="field span3">
            <label>Note</label>
            <input id="so_note" type="text" />
          </div>
        </div>

        <div class="card" style="box-shadow:none;margin-top:14px">
          <div class="row" style="margin-bottom:10px">
            <div>
              <strong>Items</strong>
              <div class="small">Add multiple items. Total auto = sum(line totals).</div>
            </div>
            <button class="btn secondary" id="btnAddItem">+ Add Item</button>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:150px">Product Category</th>
                  <th style="min-width:160px">Product</th>
                  <th style="min-width:140px">Color</th>
                  <th style="min-width:120px">Size</th>
                  <th class="right" style="min-width:90px">Qty</th>
                  <th class="right" style="min-width:110px">Unit Price</th>
                  <th class="right" style="min-width:120px">Line Total</th>
                  <th style="min-width:70px"></th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="pill">Total: <span id="so_total">0.00</span></div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn secondary" id="btnPrintLast" disabled>Print Last Saved</button>
              <button class="btn" id="btnSaveSale">Save Sale</button>
            </div>
          </div>

          <div class="small" id="soMsg" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0">Recent Orders</h2>
            <div class="small">Update Status and Paid Amount after saving. Print includes customer details.</div>
          </div>
          <button class="btn secondary" id="btnRefreshOrders">Refresh Orders</button>
        </div>

        <div style="overflow:auto;margin-top:12px">
          <table>
            <thead>
              <tr>
                <th style="min-width:160px">Customer</th>
                <th style="min-width:140px">Order ID</th>
                <th style="min-width:120px">Date</th>
                <th class="right" style="min-width:110px">Total</th>
                <th class="right" style="min-width:110px">Paid</th>
                <th style="min-width:110px">Payment</th>
                <th style="min-width:150px">Status</th>
                <th style="min-width:160px">Update Paid</th>
                <th style="min-width:80px">Print</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
        <div class="small" id="ordersMsg" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Expenses -->
    <section id="tab-exp" style="display:none">
      <div class="card">
        <h2>Expenses</h2>
        <div class="grid">
          <div class="field span3">
            <label>Date (yyyy-mm-dd)</label>
            <input id="exp_date" type="date" />
          </div>
          <div class="field span3">
            <label>Warehouse / Location</label>
            <select id="exp_location"></select>
          </div>
          <div class="field span3">
            <label>Expense Category</label>
            <select id="exp_cat"></select>
          </div>
          <div class="field span3">
            <label>Currency</label>
            <select id="exp_currency">
              <option value="USD">USD</option>
              <option value="KHR">KHR</option>
            </select>
          </div>

          <div class="field span3">
            <label>Amount</label>
            <input id="exp_amount" type="number" step="0.01" min="0" value="0.00" />
          </div>
          <div class="field span9">
            <label>Note</label>
            <input id="exp_note" type="text" />
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="note"></div>
          <button class="btn" id="btnSaveExp">Save Expense</button>
        </div>

        <div class="small" id="expMsg" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="tab-dash" style="display:none">
      <div class="card">
        <h2>Dashboard</h2>
        <div class="grid">
          <div class="field span3">
            <label>From</label>
            <input id="dash_from" type="date" />
          </div>
          <div class="field span3">
            <label>To</label>
            <input id="dash_to" type="date" />
          </div>
          <div class="field span6" style="display:flex;align-items:end;gap:10px">
            <button class="btn" id="btnLoadDash">Load</button>
            <div class="small" id="dashMsg"></div>
          </div>
        </div>

        <div class="grid" style="margin-top:14px">
          <div class="field span4"><div class="pill">Sales Total: <span id="dash_sales">0.00</span></div></div>
          <div class="field span4"><div class="pill">Expenses Total: <span id="dash_exp">0.00</span></div></div>
          <div class="field span4"><div class="pill">Net: <span id="dash_net">0.00</span></div></div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ✅ NEW API URL (fixed)
    const API_URL = "https://script.google.com/macros/s/AKfycbx1qV0ef9mvcrMlV_wibxMJ5k6MjlUvYX6H15J1UB_druLZEDTkcVc4onKp-e0ja9E/exec";

    // ---- helpers
    const $ = (id)=>document.getElementById(id);
    const fmt2 = (n)=> (isFinite(n)? Number(n).toFixed(2) : "0.00");
    const todayStr = ()=> new Date().toISOString().slice(0,10);

    async function apiGet(action, params={}){
      const u = new URL(API_URL);
      u.searchParams.set("action", action);
      Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
      const res = await fetch(u.toString(), { method:"GET" });
      const data = await res.json();
      return data;
    }
    async function apiPost(action, payload){
      const res = await fetch(API_URL, {
        method:"POST",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ action, ...payload })
      });
      const data = await res.json();
      return data;
    }

    // ---- lists cache
    let LISTS = {};
    function setOptions(sel, arr, placeholder=""){
      sel.innerHTML = "";
      if(placeholder){
        const o = document.createElement("option");
        o.value=""; o.textContent=placeholder;
        sel.appendChild(o);
      }
      (arr||[]).forEach(v=>{
        const o = document.createElement("option");
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });
    }

    async function loadLists(){
      const r = await apiGet("get_lists");
      if(!r.ok) throw new Error(r.message || "get_lists failed");
      LISTS = r.data || {};
      // Inventory
      setOptions($("inv_location"), LISTS.LOCATION || [], "");
      setOptions($("inv_prod_cat"), LISTS.PROD_CAT || [], "");
      setOptions($("inv_color"), LISTS.PROD_COLOR || [], "");
      setOptions($("inv_size"), LISTS.PROD_SIZE || [], "");
      // Sales
      setOptions($("so_location"), LISTS.LOCATION || [], "");
      setOptions($("so_delivery_company"), LISTS.DELIVERY_COMPANY || [], "");
      // Expenses
      setOptions($("exp_location"), LISTS.LOCATION || [], "");
      setOptions($("exp_cat"), LISTS.EXP_CAT || [], "");
    }

    async function ping(){
      try{
        const r = await apiGet("ping");
        $("apiStatus").innerHTML = `API: <span class="${r.ok?'ok':'bad'}">${r.ok?'OK':'ERROR'}</span>`;
      }catch(e){
        $("apiStatus").innerHTML = `API: <span class="bad">ERROR</span>`;
      }
    }

    // ---- tabs
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.dataset.tab;
        $("tab-inv").style.display = (t==="inv") ? "" : "none";
        $("tab-sales").style.display = (t==="sales") ? "" : "none";
        $("tab-exp").style.display = (t==="exp") ? "" : "none";
        $("tab-dash").style.display = (t==="dash") ? "" : "none";
      });
    });

    // ---- Inventory calc
    function recalcInv(){
      const qty = Number($("inv_qty").value||0);
      const rmb = Number($("inv_unit_rmb").value||0);
      const fx  = Number($("inv_fx").value||0);
      const unitUsd = fx>0 ? (rmb/fx) : 0;
      const amtUsd  = unitUsd * qty;
      $("inv_unit_usd").value = fmt2(unitUsd);
      $("inv_amount_usd").value = fmt2(amtUsd);
    }

    // ---- Inventory save
    async function saveInventory(){
      $("btnSaveInv").disabled = true;
      $("invMsg").textContent = "";
      try{
        const payload = {
          date: $("inv_date").value || "",
          location: $("inv_location").value || "",
          prod_cat: $("inv_prod_cat").value || "",
          product: $("inv_product").value || "",
          color: $("inv_color").value || "",
          size: $("inv_size").value || "",
          qty: Number($("inv_qty").value||0),
          unit_rmb: Number($("inv_unit_rmb").value||0),
          fx: Number($("inv_fx").value||0),
          unit_usd: Number($("inv_unit_usd").value||0),
          amount_usd: Number($("inv_amount_usd").value||0),
          note: $("inv_note").value || ""
        };
        const r = await apiPost("add_inventory_in", payload);
        if(!r.ok) throw new Error(r.message || "save failed");
        $("invMsg").textContent = "OK";
      }catch(e){
        $("invMsg").textContent = "ERROR: " + e.message;
      }finally{
        $("btnSaveInv").disabled = false;
      }
    }

    // ---- Sales items
    let salesItems = [];
    let lastSavedOrder = null;

    function blankItem(){
      return { prod_cat:"", product:"", color:"", size:"", qty:1, unit_price:0, line_total:0 };
    }
    function calcLine(it){
      const q = Number(it.qty||0);
      const p = Number(it.unit_price||0);
      it.line_total = q*p;
      return it;
    }
    function calcTotal(){
      const total = salesItems.reduce((s,it)=> s + Number(it.line_total||0), 0);
      $("so_total").textContent = fmt2(total);
      return total;
    }

    function renderItems(){
      const tb = $("itemsBody");
      tb.innerHTML = "";
      salesItems.forEach((it, idx)=>{
        const tr = document.createElement("tr");

        const tdCat = document.createElement("td");
        const selCat = document.createElement("select");
        setOptions(selCat, LISTS.PROD_CAT||[], "");
        selCat.value = it.prod_cat || "";
        selCat.onchange = ()=>{ it.prod_cat = selCat.value; };
        tdCat.appendChild(selCat);

        const tdProd = document.createElement("td");
        const inpProd = document.createElement("input");
        inpProd.value = it.product || "";
        inpProd.placeholder = "Product name";
        inpProd.oninput = ()=>{ it.product = inpProd.value; };
        tdProd.appendChild(inpProd);

        const tdColor = document.createElement("td");
        const selColor = document.createElement("select");
        setOptions(selColor, LISTS.PROD_COLOR||[], "");
        selColor.value = it.color || "";
        selColor.onchange = ()=>{ it.color = selColor.value; };
        tdColor.appendChild(selColor);

        const tdSize = document.createElement("td");
        const selSize = document.createElement("select");
        setOptions(selSize, LISTS.PROD_SIZE||[], "");
        selSize.value = it.size || "";
        selSize.onchange = ()=>{ it.size = selSize.value; };
        tdSize.appendChild(selSize);

        const tdQty = document.createElement("td");
        tdQty.className="right";
        const inpQty = document.createElement("input");
        inpQty.type="number"; inpQty.step="1"; inpQty.min="0";
        inpQty.value = it.qty ?? 0;
        inpQty.oninput = ()=>{
          it.qty = Number(inpQty.value||0);
          calcLine(it);
          tdLine.textContent = fmt2(it.line_total);
          calcTotal();
        };
        tdQty.appendChild(inpQty);

        const tdPrice = document.createElement("td");
        tdPrice.className="right";
        const inpPrice = document.createElement("input");
        inpPrice.type="number"; inpPrice.step="0.01"; inpPrice.min="0";
        inpPrice.value = it.unit_price ?? 0;
        inpPrice.oninput = ()=>{
          it.unit_price = Number(inpPrice.value||0);
          calcLine(it);
          tdLine.textContent = fmt2(it.line_total);
          calcTotal();
        };
        tdPrice.appendChild(inpPrice);

        const tdLine = document.createElement("td");
        tdLine.className="right";
        tdLine.textContent = fmt2(it.line_total||0);

        const tdDel = document.createElement("td");
        const btnX = document.createElement("button");
        btnX.className="btn danger";
        btnX.textContent="X";
        btnX.style.padding="6px 10px";
        btnX.onclick = ()=>{
          salesItems.splice(idx,1);
          if(salesItems.length===0) salesItems.push(calcLine(blankItem()));
          renderItems();
          calcTotal();
        };
        tdDel.appendChild(btnX);

        tr.appendChild(tdCat);
        tr.appendChild(tdProd);
        tr.appendChild(tdColor);
        tr.appendChild(tdSize);
        tr.appendChild(tdQty);
        tr.appendChild(tdPrice);
        tr.appendChild(tdLine);
        tr.appendChild(tdDel);

        tb.appendChild(tr);
      });
    }

    function addItemRow(){
      salesItems.push(calcLine(blankItem()));
      renderItems();
      calcTotal();
    }

    async function saveSale(){
      $("btnSaveSale").disabled = true;
      $("soMsg").textContent = "";
      try{
        const total = calcTotal();
        const payload = {
          order_date: $("so_date").value || "",
          location: $("so_location").value || "",
          customer: $("so_customer").value || "",
          delivery_company: $("so_delivery_company").value || "",
          currency: $("so_currency").value || "USD",
          cash_timing: $("so_cash_timing").value || "BEFORE",
          paid_amount: Number($("so_paid").value||0),
          note: $("so_note").value || "",
          items: salesItems.map(it=>({
            prod_cat: it.prod_cat || "",
            product: it.product || "",
            color: it.color || "",
            size: it.size || "",
            qty: Number(it.qty||0),
            unit_price: Number(it.unit_price||0),
            line_total: Number(it.line_total||0)
          })),
          total: Number(total||0)
        };
        const r = await apiPost("add_sale", payload);
        if(!r.ok) throw new Error(r.message || "save failed");
        lastSavedOrder = r.data || null;
        $("btnPrintLast").disabled = !lastSavedOrder;
        $("soMsg").textContent = "OK";
        await refreshOrders();
      }catch(e){
        $("soMsg").textContent = "ERROR: " + e.message;
      }finally{
        $("btnSaveSale").disabled = false;
      }
    }

    // ---- Orders list + updates
    async function refreshOrders(){
      $("ordersMsg").textContent = "";
      try{
        const r = await apiGet("get_recent_orders");
        if(!r.ok) throw new Error(r.message || "get_recent_orders failed");
        const rows = r.data || [];
        const tb = $("ordersBody");
        tb.innerHTML = "";
        rows.forEach(o=>{
          const tr = document.createElement("tr");

          const tdCust = document.createElement("td"); tdCust.textContent = o.customer || "";
          const tdId = document.createElement("td"); tdId.textContent = o.order_id || "";
          const tdDate = document.createElement("td"); tdDate.textContent = (o.order_date||"").slice(0,10);
          const tdTot = document.createElement("td"); tdTot.className="right"; tdTot.textContent = fmt2(Number(o.total||0));
          const tdPaid = document.createElement("td"); tdPaid.className="right"; tdPaid.textContent = fmt2(Number(o.paid_amount||0));
          const tdPay = document.createElement("td"); tdPay.textContent = o.payment_status || "";

          const tdStatus = document.createElement("td");
          const sel = document.createElement("select");
          ["NEW","PREPARING","DELIVERING","COMPLETED","CANCELLED"].forEach(s=>{
            const op=document.createElement("option"); op.value=s; op.textContent=s;
            sel.appendChild(op);
          });
          sel.value = o.status || "NEW";
          sel.onchange = async ()=>{
            try{
              const rr = await apiPost("update_order_status", { order_id:o.order_id, status: sel.value });
              if(!rr.ok) throw new Error(rr.message || "update failed");
            }catch(e){
              alert("Status update failed:\n" + e.message);
            }
          };
          tdStatus.appendChild(sel);

          const tdUpdPaid = document.createElement("td");
          const inp = document.createElement("input");
          inp.type="number"; inp.step="0.01"; inp.min="0";
          inp.value = Number(o.paid_amount||0);
          inp.style.maxWidth="120px";
          const btn = document.createElement("button");
          btn.className="btn secondary";
          btn.textContent="Update";
          btn.style.marginLeft="8px";
          btn.onclick = async ()=>{
            try{
              const rr = await apiPost("update_sale_payment", { order_id:o.order_id, paid_amount: Number(inp.value||0) });
              if(!rr.ok) throw new Error(rr.message || "update failed");
              await refreshOrders();
            }catch(e){
              alert("Payment update failed:\n" + (e.message||e));
            }
          };
          tdUpdPaid.appendChild(inp);
          tdUpdPaid.appendChild(btn);

          const tdPrint = document.createElement("td");
          const bp = document.createElement("button");
          bp.className="btn secondary";
          bp.textContent="Print";
          bp.onclick = ()=> printOrder(o.order_id);
          tdPrint.appendChild(bp);

          tr.appendChild(tdCust);
          tr.appendChild(tdId);
          tr.appendChild(tdDate);
          tr.appendChild(tdTot);
          tr.appendChild(tdPaid);
          tr.appendChild(tdPay);
          tr.appendChild(tdStatus);
          tr.appendChild(tdUpdPaid);
          tr.appendChild(tdPrint);

          tb.appendChild(tr);
        });
      }catch(e){
        $("ordersMsg").textContent = "ERROR: " + e.message;
      }
    }

    async function printLast(){
      if(!lastSavedOrder?.order_id) return;
      printOrder(lastSavedOrder.order_id);
    }

    async function printOrder(orderId){
      try{
        const r = await apiGet("get_order_print", { order_id: orderId });
        if(!r.ok) throw new Error(r.message || "print data failed");
        const d = r.data;

        const w = window.open("", "_blank");
        const html = `
          <html><head><title>Packing Slip</title>
          <style>
            body{font-family:Arial,sans-serif;margin:16px}
            h2{margin:0 0 10px}
            .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px}
            table{width:100%;border-collapse:collapse}
            th,td{border-bottom:1px solid #eee;padding:8px;font-size:12px;text-align:left}
            th{background:#fafafa}
            .right{text-align:right}
            @media print { button{display:none} }
          </style></head><body>
            <div class="small">${new Date().toLocaleString()}</div>
            <h2>Packing Slip / Delivery Label</h2>
            <div class="box">
              <div><b>Order ID:</b> ${d.order.order_id}</div>
              <div><b>Date:</b> ${(d.order.order_date||"").slice(0,10)}</div>
              <div><b>Customer:</b> ${d.order.customer||""}</div>
              <div><b>Location:</b> ${d.order.location||""}</div>
              <div><b>Delivery Company:</b> ${d.order.delivery_company||""}</div>
              <div><b>Status:</b> ${d.order.status||""}</div>
              <div><b>Total:</b> ${d.order.currency||""} ${fmt2(Number(d.order.total||0))}</div>
              <div><b>Paid:</b> ${d.order.currency||""} ${fmt2(Number(d.order.paid_amount||0))} (${d.order.payment_status||""})</div>
            </div>

            <div class="box">
              <b>Items</b>
              <table>
                <thead>
                  <tr>
                    <th>Category</th><th>Product</th><th>Color</th><th>Size</th>
                    <th class="right">Qty</th>
                  </tr>
                </thead>
                <tbody>
                  ${(d.items||[]).map(it=>`
                    <tr>
                      <td>${it.prod_cat||""}</td>
                      <td>${it.product||""}</td>
                      <td>${it.color||""}</td>
                      <td>${it.size||""}</td>
                      <td class="right">${Number(it.qty||0)}</td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>
            </div>

            <div class="box">
              <b>Note:</b> ${d.order.note||""}
            </div>

            <button onclick="window.print()">Print</button>
          </body></html>
        `;
        w.document.open();
        w.document.write(html);
        w.document.close();
      }catch(e){
        alert("Print failed:\n" + e.message);
      }
    }

    // ---- Expenses
    async function saveExpense(){
      $("btnSaveExp").disabled = true;
      $("expMsg").textContent = "";
      try{
        const payload = {
          date: $("exp_date").value || "",
          location: $("exp_location").value || "",
          exp_cat: $("exp_cat").value || "",
          currency: $("exp_currency").value || "USD",
          amount: Number($("exp_amount").value||0),
          note: $("exp_note").value || ""
        };
        const r = await apiPost("add_expense", payload);
        if(!r.ok) throw new Error(r.message || "save failed");
        $("expMsg").textContent = "OK";
      }catch(e){
        $("expMsg").textContent = "ERROR: " + e.message;
      }finally{
        $("btnSaveExp").disabled = false;
      }
    }

    // ---- Dashboard
    async function loadDashboard(){
      $("dashMsg").textContent = "";
      try{
        const from = $("dash_from").value || "";
        const to = $("dash_to").value || "";
        const r = await apiGet("dashboard", { from, to });
        if(!r.ok) throw new Error(r.message || "dashboard failed");
        const d = r.data || {};
        $("dash_sales").textContent = fmt2(Number(d.sales_total||0));
        $("dash_exp").textContent = fmt2(Number(d.expenses_total||0));
        $("dash_net").textContent = fmt2(Number(d.net||0));
        $("dashMsg").textContent = "OK";
      }catch(e){
        $("dashMsg").textContent = "ERROR: " + e.message;
      }
    }

    // ---- init
    (async function init(){
      $("inv_date").value = todayStr();
      $("so_date").value = todayStr();
      $("exp_date").value = todayStr();
      $("dash_from").value = todayStr();
      $("dash_to").value = todayStr();

      $("inv_qty").addEventListener("input", recalcInv);
      $("inv_unit_rmb").addEventListener("input", recalcInv);
      $("inv_fx").addEventListener("input", recalcInv);

      $("btnSaveInv").addEventListener("click", saveInventory);
      $("btnAddItem").addEventListener("click", addItemRow);
      $("btnSaveSale").addEventListener("click", saveSale);
      $("btnRefreshOrders").addEventListener("click", refreshOrders);
      $("btnPrintLast").addEventListener("click", printLast);
      $("btnSaveExp").addEventListener("click", saveExpense);
      $("btnLoadDash").addEventListener("click", loadDashboard);

      await ping();
      await loadLists();
      salesItems = [calcLine(blankItem())];
      renderItems();
      calcTotal();
      recalcInv();
      await refreshOrders();
    })();
  </script>
</body>
</html>
